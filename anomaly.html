<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intelligent Anomaly Grid - Enhanced</title>
    
    <style>
    /*! Bootstrap v5.3.2 CSS */
    :root{--bs-blue:#0d6efd;--bs-indigo:#6610f2;--bs-purple:#6f42c1;--bs-pink:#d63384;--bs-red:#dc3545;--bs-orange:#fd7e14;--bs-yellow:#ffc107;--bs-green:#198754;--bs-teal:#20c997;--bs-cyan:#0dcaf0;--bs-black:#000;--bs-white:#fff;--bs-gray:#6c757d;--bs-gray-dark:#343a40;--bs-gray-100:#f8f9fa;--bs-gray-200:#e9ecef;--bs-gray-300:#dee2e6;--bs-gray-400:#ced4da;--bs-gray-500:#adb5bd;--bs-gray-600:#6c757d;--bs-gray-700:#495057;--bs-gray-800:#343a40;--bs-gray-900:#212529;--bs-primary:#0d6efd;--bs-secondary:#6c757d;--bs-success:#198754;--bs-info:#0dcaf0;--bs-warning:#ffc107;--bs-danger:#dc3545;--bs-light:#f8f9fa;--bs-dark:#212529;--bs-primary-rgb:13,110,253;--bs-secondary-rgb:108,117,125;--bs-success-rgb:25,135,84;--bs-info-rgb:13,202,240;--bs-warning-rgb:255,193,7;--bs-danger-rgb:220,53,69;--bs-light-rgb:248,249,250;--bs-dark-rgb:33,37,41;--bs-white-rgb:255,255,255;--bs-black-rgb:0,0,0;--bs-body-color-rgb:33,37,41;--bs-body-bg-rgb:255,255,255;--bs-font-sans-serif:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Liberation Sans",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--bs-font-monospace:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--bs-gradient:linear-gradient(180deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0));--bs-body-font-family:var(--bs-font-sans-serif);--bs-body-font-size:1rem;--bs-body-font-weight:400;--bs-body-line-height:1.5;--bs-body-color:#212529;--bs-body-bg:#fff;--bs-border-width:1px;--bs-border-style:solid;--bs-border-color:#dee2e6;--bs-border-color-translucent:rgba(0, 0, 0, 0.175);--bs-border-radius:.375rem;--bs-border-radius-sm:.25rem;--bs-border-radius-lg:.5rem;--bs-border-radius-xl:1rem;--bs-border-radius-xxl:2rem;--bs-border-radius-2xl:var(--bs-border-radius-xxl);--bs-border-radius-pill:50rem;--bs-heading-color:inherit;--bs-link-color:#0d6efd;--bs-link-hover-color:#0a58ca;--bs-code-color:#d63384;--bs-highlight-bg:#fff3cd;--bs-highlight-color:#000}*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:var(--bs-body-font-family);font-size:var(--bs-body-font-size);font-weight:var(--bs-body-font-weight);line-height:var(--bs-body-line-height);color:var(--bs-body-color);text-align:var(--bs-body-text-align);background-color:var(--bs-body-bg);-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;border:0;border-top:1px solid;opacity:.25}.h1,.h2,.h3,.h4,.h5,.h6,h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2;color:var(--bs-heading-color)}.h1,h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){.h1,h1{font-size:2.5rem}}.h2,h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){.h2,h2{font-size:2rem}}.h3,h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){.h3,h3{font-size:1.75rem}}.h4,h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){.h4,h4{font-size:1.5rem}}.h5,h5{font-size:1.25rem}.h6,h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}.lead{font-size:1.25rem;font-weight:300}a{color:var(--bs-link-color);text-decoration:underline}a:hover{color:var(--bs-link-hover-color)}table{caption-side:bottom;border-collapse:collapse}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}.badge{display:inline-block;padding:.35em .65em;font-size:.75em;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:baseline;border-radius:.25rem}.form-check{display:block;min-height:1.5rem;padding-left:1.5em;margin-bottom:.125rem}.form-check .form-check-input{float:left;margin-left:-1.5em}.form-check-input{width:1em;height:1em;margin-top:.25em;vertical-align:top;background-color:#fff;background-repeat:no-repeat;background-position:center;background-size:contain;border:1px solid #dee2e6;-webkit-appearance:none;-moz-appearance:none;appearance:none;print-color-adjust:exact}.form-check-input[type=checkbox]{border-radius:.25em}.form-check-input:active{filter:brightness(90%)}.form-check-input:focus{border-color:#86b7fe;outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}.form-check-input:checked{background-color:#0d6efd;border-color:#0d6efd}.form-check-input:checked[type=checkbox]{background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e")}.form-select{display:block;width:100%;padding:.375rem 2.25rem .375rem .75rem;font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:right .75rem center;background-size:16px 12px;border:1px solid #ced4da;border-radius:.375rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out;-webkit-appearance:none;-moz-appearance:none;appearance:none}.form-select:focus{border-color:#86b7fe;outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}.form-select-sm{padding-top:.25rem;padding-bottom:.25rem;padding-left:.5rem;font-size:.875rem;border-radius:.25rem}.form-control{display:block;width:100%;padding:.375rem .75rem;font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;background-clip:padding-box;border:1px solid #ced4da;-webkit-appearance:none;-moz-appearance:none;appearance:none;border-radius:.375rem;transition:border-color .15s ease-in-out,box-shadow .15s ease-in-out}.form-control:focus{color:#212529;background-color:#fff;border-color:#86b7fe;outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}.form-control:disabled{background-color:#e9ecef;opacity:1}.btn{display:inline-block;font-weight:400;line-height:1.5;color:#212529;text-align:center;text-decoration:none;vertical-align:middle;cursor:pointer;user-select:none;background-color:transparent;border:1px solid transparent;padding:.375rem .75rem;font-size:1rem;border-radius:.375rem;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out}.btn-primary{color:#fff;background-color:#0d6efd;border-color:#0d6efd}.btn-primary:hover{color:#fff;background-color:#0b5ed7;border-color:#0a58ca}.btn-secondary{color:#fff;background-color:#6c757d;border-color:#6c757d}.btn-secondary:hover{color:#fff;background-color:#5c636a;border-color:#565e64}.btn-sm{padding:.25rem .5rem;font-size:.875rem;border-radius:.25rem}.btn-outline-danger{color:#dc3545;border-color:#dc3545}.btn-outline-danger:hover{color:#fff;background-color:#dc3545;border-color:#dc3545}.nav{display:flex;flex-wrap:wrap;padding-left:0;margin-bottom:0;list-style:none}.nav-pills .nav-link,.nav-tabs .nav-link{border-radius:.375rem}.nav-tabs{border-bottom:1px solid #dee2e6}.nav-tabs .nav-link{margin-bottom:-1px;background:0 0;border:1px solid transparent;border-top-left-radius:.375rem;border-top-right-radius:.375rem}.nav-tabs .nav-link:focus,.nav-tabs .nav-link:hover{isolation:isolate;border-color:#e9ecef #e9ecef #dee2e6}.nav-tabs .nav-link.active{color:#495057;background-color:#fff;border-color:#dee2e6 #dee2e6 #fff}.tab-content>.tab-pane{display:none}.tab-content>.active{display:block}.alert{position:relative;padding:1rem 1rem;margin-bottom:1rem;border:1px solid transparent;border-radius:.375rem}.alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5}.alert-success{color:#0a3622;background-color:#d1e7dd;border-color:#badbcc}.alert-info{color:#055160;background-color:#cff4fc;border-color:#b6effb}.pagination{display:flex;padding-left:0;list-style:none}.page-link{position:relative;display:block;padding:.375rem .75rem;color:#0d6efd;text-decoration:none;background-color:#fff;border:1px solid #dee2e6;transition:color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out}.page-link:hover{z-index:2;color:#0a58ca;background-color:#e9ecef;border-color:#dee2e6}.page-link:focus{z-index:3;color:#0a58ca;background-color:#e9ecef;outline:0;box-shadow:0 0 0 .25rem rgba(13,110,253,.25)}.page-item:not(:first-child) .page-link{margin-left:-1px}.page-item.active .page-link{z-index:3;color:#fff;background-color:#0d6efd;border-color:#0d6efd}.page-item.disabled .page-link{color:#6c757d;pointer-events:none;background-color:#fff;border-color:#dee2e6}.ms-1{margin-left:.25rem!important}.ms-2{margin-left:.5rem!important}.pb-2{padding-bottom:.5rem!important}.container-fluid{width:100%;padding-right:var(--bs-gutter-x,.75rem);padding-left:var(--bs-gutter-x,.75rem);margin-right:auto;margin-left:auto}.row{--bs-gutter-x:1.5rem;--bs-gutter-y:0;display:flex;flex-wrap:wrap;margin-top:calc(-1 * var(--bs-gutter-y));margin-right:calc(-.5 * var(--bs-gutter-x));margin-left:calc(-.5 * var(--bs-gutter-x))}.row>*{flex-shrink:0;width:100%;max-width:100%;padding-right:calc(var(--bs-gutter-x) * .5);padding-left:calc(var(--bs-gutter-x) * .5);margin-top:var(--bs-gutter-y)}.col,.col-md-2,.col-md-3,.col-md-6,.col-md-9{flex:0 0 auto}@media (min-width:768px){.col-md-2{width:16.66666667%}.col-md-3{width:25%}.col-md-6{width:50%}.col-md-9{width:75%}}.table{--bs-table-color:#212529;--bs-table-bg:transparent;width:100%;margin-bottom:1rem;vertical-align:top;border-color:#dee2e6}.table>tbody{vertical-align:inherit}.table>thead{vertical-align:bottom}.table>:not(caption)>*>*{padding:.5rem .5rem;background-color:var(--bs-table-bg);border-bottom-width:1px;box-shadow:inset 0 0 0 9999px var(--bs-table-accent-bg)}.table-hover>tbody>tr:hover>*{--bs-table-accent-bg:rgba(0, 0, 0, 0.075);color:var(--bs-table-hover-color)}.table-striped>tbody>tr:nth-of-type(odd)>*{--bs-table-accent-bg:rgba(0, 0, 0, 0.05)}.table-sm>tbody>tr>*{padding:.25rem .25rem}.table-primary{--bs-table-color:#000;--bs-table-bg:#cfe2ff;--bs-table-border-color:#bacbe6}.table-responsive{overflow-x:auto}.table-bordered{border:1px solid #dee2e6}.table-bordered>:not(caption)>*>*{border-width:1px}.d-flex{display:flex!important}.flex-column{flex-direction:column!important}.justify-content-center{justify-content:center!important}.justify-content-end{justify-content:flex-end!important}.justify-content-between{justify-content:space-between!important}.align-items-center{align-items:center!important}.my-auto{margin-top:auto!important;margin-bottom:auto!important}.g-4{--bs-gutter-x:1.5rem;--bs-gutter-y:1.5rem}.mt-2{margin-top:.5rem!important}.mt-3{margin-top:1rem!important}.mb-2{margin-bottom:.5rem!important}.mb-3{margin-bottom:1rem!important}.mb-4{margin-bottom:1.5rem!important}.p-3{padding:1rem!important}.p-4{padding:1.5rem!important}.border{border:1px solid #dee2e6!important}.border-bottom{border-bottom:1px solid #dee2e6!important}.text-dark{--bs-text-opacity:1;color:rgba(var(--bs-dark-rgb),var(--bs-text-opacity))!important}.text-center{text-align:center!important}.text-muted{--bs-text-opacity:1;color:#6c757d!important}.text-primary{--bs-text-opacity:1;color:rgba(var(--bs-primary-rgb),var(--bs-text-opacity))!important}.fw-bold{font-weight:700!important}.small{font-size:.875em}

    /* Custom application styles */
    body { background-color: #f8f9fa; font-size: 0.95rem; }
    .header { background-color: #343a40; color: white; padding: 20px; text-align: center; margin-bottom: 20px; }
    .panel { background-color: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); height: 85vh; }
    .nav-tabs .nav-link { font-weight: 500; }
    .sortable-header { cursor: pointer; user-select: none; }
    .sortable-header:hover { background-color: #f0f0f0; }
    .chart-container { position: relative; height: 100%; width: 100%; min-height: 350px; }
    .page-link { cursor: pointer; }
    .filter-panel { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: .375rem; }
    .filter-group .form-label { font-size: 0.9rem; font-weight: bold; margin-bottom: 0.25rem; }
    
    /* Multi-select dropdown styling */
    .multi-select-dropdown { position: relative; }
    .multi-select-button { 
        width: 100%; 
        font-size: .875rem; 
        text-align: left; 
        background-color: white; 
        border: 1px solid #ced4da; 
        padding: .25rem .5rem; 
        border-radius: .25rem; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        cursor: pointer;
        min-height: 31px;
    }
    .multi-select-button:hover { background-color: #f8f9fa; }
    .multi-select-button::after { 
        content: "▼"; 
        font-size: 0.7rem; 
        color: #6c757d;
        margin-left: .5rem;
    }
    .multi-select-menu { 
        display: none; 
        position: absolute; 
        width: 100%; 
        max-height: 250px; 
        overflow-y: auto; 
        background-color: white; 
        border: 1px solid #ced4da; 
        border-radius: .375rem; 
        z-index: 1050; 
        padding: .5rem; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        margin-top: 2px;
    }
    .multi-select-menu.show { display: block; }
    .multi-select-option { 
        padding: .4rem .5rem; 
        cursor: pointer; 
        border-radius: .25rem;
        display: flex;
        align-items: center;
    }
    .multi-select-option:hover { background-color: #f8f9fa; }
    .multi-select-option input[type="checkbox"] { 
        margin-right: .5rem; 
        cursor: pointer;
    }
    .multi-select-option.all-option {
        font-weight: 600;
        border-bottom: 1px solid #dee2e6;
        margin-bottom: .25rem;
        padding-bottom: .5rem;
    }
    .selected-count { 
        color: #0d6efd; 
        font-weight: 600; 
        font-size: 0.85rem;
    }
    
    .annotated-row td { color: #6c757d; font-style: italic; }
    .granular-section { margin-bottom: 2rem; }
    .granular-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: .375rem; padding: 1rem; margin-bottom: 1rem; }
    .visitor-badge { display: inline-block; background: #0d6efd; color: white; padding: .25rem .5rem; border-radius: .25rem; margin-right: .5rem; margin-bottom: .5rem; font-size: .85rem; }
    .detail-label { font-weight: 600; color: #495057; min-width: 150px; display: inline-block; }
    .detail-value { color: #212529; }
    .back-button { position: sticky; top: 10px; z-index: 100; }

    @media (max-width: 992px) {
        .panel { height: auto; margin-bottom: 1.5rem; }
        .chart-container { height: 40vh; }
    }
    </style>
</head>
<body>

    <div class="header">
        <h1>🚀 Intelligent Anomaly Grid</h1>
        <p class="lead mb-0">Enhanced with Multi-Select Filters & Granular Details</p>
    </div>

    <div class="container-fluid px-4">
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#explorer-tab-pane">Annotation Explorer</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="granular-tab-btn" data-bs-toggle="tab" data-bs-target="#granular-tab-pane">Granular Details</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#log-tab-pane">Annotation Log</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics-tab-pane">Analytics Dashboard</button></li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- ANNOTATION EXPLORER TAB -->
            <div class="tab-pane fade show active" id="explorer-tab-pane" role="tabpanel">
                <div class="row g-4 mt-2">
                    <div class="col-md-3">
                        <div class="panel">
                            <h4 class="mb-3">Path Explorer</h4>
                            <p class="small text-muted">Check one or more paths to view records.</p>
                            <div id="paths-list-container" class="table-responsive" style="height: 85%; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="panel">
                            <div id="details-container" class="d-flex flex-column h-100">
                                <div class="text-center my-auto"><p class="text-muted">Select one or more paths from the left to begin.</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GRANULAR DETAILS TAB -->
            <div class="tab-pane fade" id="granular-tab-pane" role="tabpanel">
                <div class="panel mt-3" style="height: auto; max-height: 85vh; overflow-y: auto;">
                    <div id="granular-details-content">
                        <div class="text-center my-auto p-5">
                            <p class="text-muted">Click on any row in the Annotation Explorer to view granular details.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ANNOTATION LOG TAB -->
            <div class="tab-pane fade" id="log-tab-pane" role="tabpanel">
                <div class="panel mt-3">
                    <h4 class="mb-3">Annotation Log</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead id="log-table-head"></thead>
                            <tbody id="log-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ANALYTICS DASHBOARD TAB -->
            <div class="tab-pane fade" id="analytics-tab-pane" role="tabpanel">
                 <div class="panel mt-3">
                    <ul class="nav nav-pills mb-3" id="analyticsSubTab" role="tablist">
                        <li class="nav-item" role="presentation"><button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-pane">Overview</button></li>
                        <li class="nav-item" role="presentation"><button class="nav-link" id="heatmap-tab" data-bs-toggle="tab" data-bs-target="#heatmap-pane">Heatmap</button></li>
                    </ul>
                    <div class="tab-content" id="analyticsSubTabContent">
                        <div class="tab-pane fade show active" id="overview-pane" role="tabpanel">
                            <div id="analytics-overview-controls" class="d-flex justify-content-end align-items-center mb-2"></div>
                            <div class="row">
                                <div class="col-md-6"><div class="chart-container"><canvas id="annotation-pie-chart"></canvas></div></div>
                                <div class="col-md-6"><div class="chart-container"><canvas id="user-bar-chart"></canvas></div></div>
                            </div>
                            <h5 class="mt-3">Filtered Log</h5>
                            <div id="analytics-log-table" class="table-responsive" style="height: 25vh;"></div>
                        </div>
                        <div class="tab-pane fade" id="heatmap-pane" role="tabpanel">
                             <h5 class="mb-3">Anomaly Rate by Team and Journey Type</h5>
                             <p class="text-muted small">Color intensity indicates the percentage of records classified as a key anomaly type.</p>
                             <div class="chart-container"><canvas id="heatmap-chart"></canvas></div>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1/dist/chartjs-chart-matrix.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Enhanced sample data with granular details
        const sampleData = [
            { 
                "row_id": 'a1', "Week number": 40, "path": '/home', "Journey type": "Basic", 
                "Team": "US", "Business Unit": "Consumer", "Device": "mobile", 
                "Completed": "yes", "hard anomaly": "false",
                "granular_details": [
                    {
                        visitor_id: "V00123", visitor_no: 1, visitor_pg_no: [3, 4, 8, 57],
                        mcvid: "MCVID_ABC123", agent_id: "AG_001", correlation_id: "CORR_XYZ789",
                        URL_Referral: "https://google.com/search?q=product",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/abc123"
                    },
                    {
                        visitor_id: "V00124", visitor_no: 1, visitor_pg_no: [1, 2, 5, 10, 12],
                        mcvid: "MCVID_ABC124", agent_id: "AG_001", correlation_id: "CORR_XYZ790",
                        URL_Referral: "https://facebook.com/ad/campaign",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/abc124"
                    },
                    {
                        visitor_id: "V00124", visitor_no: 2, visitor_pg_no: [15, 20, 25],
                        mcvid: "MCVID_ABC124", agent_id: "AG_002", correlation_id: "CORR_XYZ791",
                        URL_Referral: "https://google.com/search?q=homepage",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/abc125"
                    }
                ]
            },
            { 
                "row_id": 'a2', "Week number": 40, "path": '/home', "Journey type": "Upgraded", 
                "Team": "US", "Business Unit": "PL", "Device": "PC", 
                "Completed": "no", "hard anomaly": "true",
                "granular_details": [
                    {
                        visitor_id: "V00225", visitor_no: 1, visitor_pg_no: [2, 5, 7],
                        mcvid: "MCVID_DEF456", agent_id: "AG_003", correlation_id: "CORR_ABC001",
                        URL_Referral: "https://linkedin.com/posts/tech",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/def456"
                    }
                ]
            },
            { 
                "row_id": 'b1', "Week number": 41, "path": '/home', "Journey type": "Basic", 
                "Team": "India", "Business Unit": "Consumer", "Device": "mobile", 
                "Completed": "yes", "hard anomaly": "false",
                "granular_details": [
                    {
                        visitor_id: "V00326", visitor_no: 1, visitor_pg_no: [1, 3, 5, 8, 12, 15],
                        mcvid: "MCVID_GHI789", agent_id: "AG_004", correlation_id: "CORR_ABC002",
                        URL_Referral: "https://twitter.com/ad/promo",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/ghi789"
                    },
                    {
                        visitor_id: "V00327", visitor_no: 1, visitor_pg_no: [4, 6, 9],
                        mcvid: "MCVID_GHI790", agent_id: "AG_004", correlation_id: "CORR_ABC003",
                        URL_Referral: "https://bing.com/search",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/ghi790"
                    }
                ]
            },
            { 
                "row_id": 'c1', "Week number": 41, "path": '/products', "Journey type": null, 
                "Team": "US", "Business Unit": "sbs", "Device": "desktop", 
                "Completed": "yes", "hard anomaly": "false",
                "granular_details": [
                    {
                        visitor_id: "V00428", visitor_no: 1, visitor_pg_no: [10, 15, 20, 25],
                        mcvid: "MCVID_JKL012", agent_id: "AG_005", correlation_id: "CORR_ABC004",
                        URL_Referral: "https://reddit.com/r/technology",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/jkl012"
                    }
                ]
            },
            { 
                "row_id": 'c2', "Week number": 42, "path": '/products', "Journey type": "Upgraded", 
                "Team": "India", "Business Unit": "PL", "Device": null, 
                "Completed": "no", "hard anomaly": "true",
                "granular_details": [
                    {
                        visitor_id: "V00529", visitor_no: 1, visitor_pg_no: [5, 10, 15, 20, 25, 30],
                        mcvid: "MCVID_MNO345", agent_id: "AG_006", correlation_id: "CORR_ABC005",
                        URL_Referral: "https://instagram.com/ad/story",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/mno345"
                    },
                    {
                        visitor_id: "V00529", visitor_no: 2, visitor_pg_no: [35, 40],
                        mcvid: "MCVID_MNO345", agent_id: "AG_007", correlation_id: "CORR_ABC006",
                        URL_Referral: "https://youtube.com/watch",
                        ContentSquare_URL_Link: "https://contentsquare.com/session/mno346"
                    }
                ]
            },
            ...Array.from({length: 50}, (_, i) => ({ 
                "row_id": `z${i}`, 
                "Week number": 40 + (i%3), 
                "path": '/checkout', 
                "Journey type": ["Basic", "Upgraded", null][i%3], 
                "Team": ["US", "India"][i%2], 
                "Business Unit": ["Consumer", "sbs", "PL"][i%3], 
                "Device": ["mobile", "PC", null][i%3], 
                "Completed": ["yes", "no"][i%2], 
                "hard anomaly": ["true", "false"][i%2],
                "granular_details": [
                    {
                        visitor_id: `V${String(i + 600).padStart(5, '0')}`,
                        visitor_no: 1,
                        visitor_pg_no: [1, 2, 3, 5, 8, 13].slice(0, (i % 4) + 2),
                        mcvid: `MCVID_Z${String(i).padStart(3, '0')}`,
                        agent_id: `AG_${String((i % 10) + 1).padStart(3, '0')}`,
                        correlation_id: `CORR_Z${String(i).padStart(3, '0')}`,
                        URL_Referral: `https://example.com/ref${i}`,
                        ContentSquare_URL_Link: `https://contentsquare.com/session/z${i}`
                    }
                ]
            }))
        ];

        const ROWS_PER_PAGE = 10;
        const FILTERABLE_COLUMNS = ["Journey type", "Team", "Business Unit", "Device", "Completed", "hard anomaly"];
        const ANNOTATION_CATEGORIES = ["System Error", "Data Glitch", "User Error", "Expected Behavior", "Fraudulent Activity", "Test/QA Activity", "Needs Investigation"];
        const ANOMALY_TYPES_FOR_HEATMAP = ["System Error", "Data Glitch", "Fraudulent Activity"];
        const DISPLAY_COLUMNS = ["row_id", "Week number", "path", "Journey type", "Team", "Business Unit", "Device", "Completed", "hard anomaly", "Annotation", "Comment"];
        const LOG_DISPLAY_COLUMNS = ["row_id", "Week number", "path", "Journey type", "Team", "Business Unit", "Device", "Completed", "hard anomaly", "Annotation", "Comment", "Timestamp"];
        
        let appData = sampleData;
        let selectedRowForAnnotation = null;
        let currentDetailRecords = [];
        let gridState = { filters: {}, sortColumn: 'row_id', sortDirection: 'asc', currentPage: 1 };
        const selectedPaths = new Set();
        let annotationLog = [];
        let analyticsFilters = {};
        let currentGranularRow = null;
        
        const pathsListContainer = document.getElementById('paths-list-container');
        const detailsContainer = document.getElementById('details-container');
        const logTableBody = document.getElementById('log-table-body');
        const analyticsTabBtn = document.getElementById('analytics-tab');
        const granularTabBtn = document.getElementById('granular-tab-btn');
        const granularDetailsContent = document.getElementById('granular-details-content');
        
        function initializeApp() {
            const pathCounts = appData.reduce((acc, {path}) => ({...acc, [path]: (acc[path] || 0) + 1}), {});
            let pathsHTML = `<div class="form-check ms-2 fw-bold border-bottom pb-2 mb-2"><input class="form-check-input" type="checkbox" id="path-select-all"><label class="form-check-label" for="path-select-all">Select All</label></div>`;
            Object.entries(pathCounts).sort((a, b) => a[0].localeCompare(b[0])).forEach(([path, count]) => {
                pathsHTML += `<div class="form-check ms-2"><input class="form-check-input path-checkbox" type="checkbox" value="${path}" id="path-${path.replace(/[^a-zA-Z0-9]/g, '')}"><label class="form-check-label" for="path-${path.replace(/[^a-zA-Z0-9]/g, '')}">${path} <span class="text-muted">(${count})</span></label></div>`;
            });
            pathsListContainer.innerHTML = pathsHTML;
            
            const logTableHead = document.querySelector('#log-tab-pane thead');
            if (logTableHead) {
                logTableHead.innerHTML = `<tr>${LOG_DISPLAY_COLUMNS.map(h => `<th>${h.replace(/_/g, ' ')}</th>`).join('')}</tr>`;
            }
        }

        pathsListContainer.addEventListener('change', (e) => {
            const target = e.target;
            if (target.id === 'path-select-all') {
                pathsListContainer.querySelectorAll('.path-checkbox').forEach(cb => {
                    cb.checked = target.checked;
                    if (target.checked) selectedPaths.add(cb.value); else selectedPaths.delete(cb.value);
                });
            } else if (target.classList.contains('path-checkbox')) {
                if (target.checked) selectedPaths.add(target.value); else selectedPaths.delete(target.value);
                document.getElementById('path-select-all').checked = [...pathsListContainer.querySelectorAll('.path-checkbox')].every(c => c.checked);
            }
            loadDetailsForSelectedPaths();
        });

        // Multi-select filter change handler
        detailsContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('multi-select-checkbox')) {
                const column = e.target.dataset.column;
                const value = e.target.value;
                
                if (!gridState.filters[column]) {
                    gridState.filters[column] = new Set();
                }
                
                if (value === '__ALL__') {
                    const allCheckboxes = detailsContainer.querySelectorAll(`.multi-select-checkbox[data-column="${column}"]`);
                    if (e.target.checked) {
                        allCheckboxes.forEach(cb => {
                            cb.checked = true;
                            if (cb.value !== '__ALL__') gridState.filters[column].add(cb.value);
                        });
                    } else {
                        allCheckboxes.forEach(cb => cb.checked = false);
                        gridState.filters[column].clear();
                    }
                } else {
                    if (e.target.checked) {
                        gridState.filters[column].add(value);
                    } else {
                        gridState.filters[column].delete(value);
                        const allCheckbox = detailsContainer.querySelector(`.multi-select-checkbox[data-column="${column}"][value="__ALL__"]`);
                        if (allCheckbox) allCheckbox.checked = false;
                    }
                }
                
                updateMultiSelectDisplay(column);
                gridState.currentPage = 1;
                updateGridView();
            }
            
            if (e.target.id === 'annotation-dropdown') {
                document.getElementById('submit-annotation-btn').disabled = e.target.value === "";
            }
        });
        
        // Close multi-select dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select-dropdown')) {
                document.querySelectorAll('.multi-select-menu').forEach(menu => menu.classList.remove('show'));
            }
        });
        
        detailsContainer.addEventListener('click', (e) => {
            const target = e.target;
            
            // Multi-select button toggle
            if (target.classList.contains('multi-select-button') || target.closest('.multi-select-button')) {
                e.stopPropagation();
                const button = target.classList.contains('multi-select-button') ? target : target.closest('.multi-select-button');
                const menu = button.nextElementSibling;
                const isCurrentlyOpen = menu.classList.contains('show');
                
                document.querySelectorAll('.multi-select-menu').forEach(m => m.classList.remove('show'));
                
                if (!isCurrentlyOpen) {
                    menu.classList.add('show');
                }
                return;
            }
            
            if (target.classList.contains('page-link') && !target.parentElement.classList.contains('disabled')) {
                gridState.currentPage = parseInt(target.dataset.page);
                updateGridView();
            } else if (target.classList.contains('sortable-header')) {
                const newSortColumn = target.dataset.column;
                if (gridState.sortColumn === newSortColumn) gridState.sortDirection = gridState.sortDirection === 'asc' ? 'desc' : 'asc';
                else { gridState.sortColumn = newSortColumn; gridState.sortDirection = 'asc'; }
                gridState.currentPage = 1;
                updateGridView();
            } else if (target.closest('tr') && target.closest('tbody')?.id === 'details-table-body') {
                const detailRow = target.closest('tr');
                selectedRowForAnnotation = currentDetailRecords.find(d => d.row_id === detailRow.dataset.rowId);
                [...detailRow.parentElement.rows].forEach(r => r.classList.remove('table-primary'));
                detailRow.classList.add('table-primary');
                const isAnnotated = annotationLog.some(log => log.row_id === selectedRowForAnnotation.row_id);
                document.getElementById('annotation-dropdown').disabled = isAnnotated;
                document.getElementById('comment-input').disabled = isAnnotated;
                document.getElementById('submit-annotation-btn').disabled = isAnnotated || document.getElementById('annotation-dropdown').value === "";
                
                loadGranularDetails(selectedRowForAnnotation);
            } else if (target.id === 'submit-annotation-btn') {
                handleAnnotation();
            }
        });

        function updateMultiSelectDisplay(column) {
            const button = detailsContainer.querySelector(`.multi-select-button[data-column="${column}"]`);
            if (!button) return;
            
            const selectedCount = gridState.filters[column] ? gridState.filters[column].size : 0;
            const span = button.querySelector('.selected-count') || button.querySelector('span');
            
            if (selectedCount === 0) {
                span.textContent = 'All';
                span.className = '';
            } else {
                span.textContent = `${selectedCount} selected`;
                span.className = 'selected-count';
            }
        }

        function loadDetailsForSelectedPaths() {
            if (selectedPaths.size === 0) {
                detailsContainer.innerHTML = `<div class="text-center my-auto"><p class="text-muted">Select one or more paths from the left to begin.</p></div>`;
                return;
            }
            currentDetailRecords = appData.filter(row => selectedPaths.has(row.path));
            gridState = { filters: {}, sortColumn: 'row_id', sortDirection: 'asc', currentPage: 1 };
            renderDetailsView();
        }

        function renderDetailsView() {
            const annotationMap = new Map(annotationLog.map(log => [log.row_id, log]));
            const enrichedData = currentDetailRecords.map(row => {
                const logEntry = annotationMap.get(row.row_id);
                return { ...row, Annotation: logEntry ? logEntry.annotation : null, Comment: logEntry ? logEntry.comment : null };
            });
            
            const filterOptions = {};
            FILTERABLE_COLUMNS.forEach(col => {
                const values = [...new Set(enrichedData.map(row => row[col]))].sort();
                filterOptions[col] = values;
            });
            
            let filterPanelHTML = '<div class="filter-panel p-3 mb-3 row g-3">';
            for(const [column, values] of Object.entries(filterOptions)) {
                const columnId = column.replace(/\s+/g, '_');
                filterPanelHTML += `
                    <div class="col-md-2 filter-group">
                        <label class="form-label">${column}</label>
                        <div class="multi-select-dropdown">
                            <div class="multi-select-button" data-column="${column}">
                                <span>All</span>
                            </div>
                            <div class="multi-select-menu">
                                <div class="multi-select-option all-option">
                                    <input type="checkbox" class="multi-select-checkbox" data-column="${column}" value="__ALL__" id="all-${columnId}" checked>
                                    <label for="all-${columnId}" style="cursor:pointer; margin:0; flex:1;">Select All</label>
                                </div>
                                ${values.map((value, idx) => {
                                    const displayValue = value === null ? '(Blank)' : value;
                                    const valueId = `${columnId}-${idx}`;
                                    return `
                                        <div class="multi-select-option">
                                            <input type="checkbox" class="multi-select-checkbox" data-column="${column}" value="${value}" id="${valueId}">
                                            <label for="${valueId}" style="cursor:pointer; margin:0; flex:1;">${displayValue}</label>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            filterPanelHTML += '</div>';

            detailsContainer.innerHTML = `
                ${filterPanelHTML}
                <div id="grid-summary" class="text-muted small mb-2"></div>
                <div class="table-responsive" style="flex-grow: 1; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead id="details-table-head"></thead>
                        <tbody id="details-table-body"></tbody>
                    </table>
                </div>
                <div id="pagination-controls" class="d-flex justify-content-center mt-3"></div>
                <div id="annotation-controls" class="mt-auto pt-3 border-top">
                     <h5 class="mb-3">Classify Anomaly</h5>
                     <div id="annotation-alert-spot" class="mb-2"></div>
                     <div class="row">
                        <div class="col-md-4">
                            <label for="annotation-dropdown" class="form-label">Classification</label>
                            <select id="annotation-dropdown" class="form-select" disabled>
                                <option value="" selected>Choose a classification...</option>
                                ${ANNOTATION_CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label for="comment-input" class="form-label">Comment</label>
                            <textarea class="form-control" id="comment-input" rows="1" placeholder="Add an optional comment..." disabled></textarea>
                        </div>
                     </div>
                     <div id="buttons-container" class="d-flex justify-content-end gap-2 mt-3">
                       <button id="submit-annotation-btn" class="btn btn-primary" disabled>Submit</button>
                     </div>
                </div>`;
            updateGridView();
        }

        function updateGridView() {
            let processedData = currentDetailRecords.filter(row => {
                return Object.entries(gridState.filters).every(([column, selectedValues]) => {
                    if (!selectedValues || selectedValues.size === 0) return true;
                    return selectedValues.has(String(row[column]));
                });
            });

            processedData.sort((a, b) => {
                const valA = a[gridState.sortColumn]; const valB = b[gridState.sortColumn];
                if (valA < valB) return gridState.sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return gridState.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            const totalRecords = processedData.length;
            const startRecord = totalRecords === 0 ? 0 : (gridState.currentPage - 1) * ROWS_PER_PAGE + 1;
            const endRecord = Math.min(startRecord + ROWS_PER_PAGE - 1, totalRecords);
            document.getElementById('grid-summary').textContent = totalRecords > 0 ? `Showing ${startRecord}-${endRecord} of ${totalRecords} records.` : 'No records match your filters.';
            
            renderTablePage(processedData);
            renderPaginationControls(totalRecords);
        }

        function renderTablePage(data) {
            const tableHead = document.getElementById('details-table-head');
            const tableBody = document.getElementById('details-table-body');
            const headers = DISPLAY_COLUMNS;
            
            tableHead.innerHTML = `<tr>${headers.map(h => {
                if (h === 'Annotation' || h === 'Comment') return '';
                return `<th class="sortable-header" data-column="${h}">${h.replace(/_/g, ' ')} ${gridState.sortColumn === h ? (gridState.sortDirection === 'asc' ? '▲':'▼') : ''}</th>`;
            }).join('')}</tr>`;
            
            tableBody.innerHTML = '';
            const start = (gridState.currentPage - 1) * ROWS_PER_PAGE;
            const paginatedItems = data.slice(start, start + ROWS_PER_PAGE);

            paginatedItems.forEach(rec => {
                const row = tableBody.insertRow();
                row.style.cursor = 'pointer';
                row.dataset.rowId = rec.row_id;
                row.title = "Click to view granular details";
                
                if (annotationLog.some(log => log.row_id === rec.row_id)) row.classList.add('annotated-row');

                row.innerHTML = headers.map(h => {
                    if (h === 'Annotation' || h === 'Comment') return '';
                    let cellValue = rec[h] === null ? '<em>(Blank)</em>' : rec[h];
                    return `<td>${cellValue}</td>`;
                }).join('');
            });
        }
        
        function renderPaginationControls(totalRecords) {
            const paginationContainer = document.getElementById('pagination-controls');
            const totalPages = Math.ceil(totalRecords / ROWS_PER_PAGE);
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;
            let html = '<ul class="pagination pagination-sm">';
            html += `<li class="page-item ${gridState.currentPage === 1 ? 'disabled' : ''}"><a class="page-link" data-page="${gridState.currentPage - 1}">Prev</a></li>`;
            for (let i = 1; i <= totalPages; i++) html += `<li class="page-item ${i === gridState.currentPage ? 'active' : ''}"><a class="page-link" data-page="${i}">${i}</a></li>`;
            html += `<li class="page-item ${gridState.currentPage === totalPages ? 'disabled' : ''}"><a class="page-link" data-page="${gridState.currentPage + 1}">Next</a></li>`;
            paginationContainer.innerHTML = html + '</ul>';
        }

        // FIXED: Load Granular Details with exploded rows and proper badge colors
        function loadGranularDetails(rowData) {
            currentGranularRow = rowData;
            
            let html = `
                <div class="back-button mb-3">
                    <button class="btn btn-secondary btn-sm" onclick="document.querySelector('[data-bs-target=\\'#explorer-tab-pane\\']').click()">
                        ← Back to Explorer
                    </button>
                    <button class="btn btn-primary btn-sm ms-2" onclick="document.getElementById('granular-tab-btn').click()">
                        View Granular Details →
                    </button>
                </div>
                
                <div class="granular-section">
                    <h3 class="mb-3">Row Summary</h3>
                    <div class="granular-card">
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Row ID:</span>
                                <span class="detail-value fw-bold">${rowData.row_id}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Week Number:</span>
                                <span class="detail-value">${rowData['Week number']}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Path:</span>
                                <span class="detail-value text-primary">${rowData.path}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Journey Type:</span>
                                <span class="detail-value">${rowData['Journey type'] || '(Blank)'}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Team:</span>
                                <span class="detail-value">${rowData.Team}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Business Unit:</span>
                                <span class="detail-value">${rowData['Business Unit']}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Device:</span>
                                <span class="detail-value">${rowData.Device || '(Blank)'}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Completed:</span>
                                <span class="detail-value">${rowData.Completed}</span>
                            </div>
                            <div class="col-md-6 mb-2">
                                <span class="detail-label">Hard Anomaly:</span>
                                <span class="badge ${rowData['hard anomaly'] === 'true' ? 'bg-danger' : 'bg-success'}">${rowData['hard anomaly']}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="granular-section">
                    <h3 class="mb-3">Visitor Details</h3>
                    <div class="alert alert-info">
                        <strong>Note:</strong> Each visitor_pg_no is shown as a separate row for detailed analysis.
                    </div>
            `;
            
            if (rowData.granular_details && rowData.granular_details.length > 0) {
                // Group by visitor_id
                const visitorGroups = {};
                rowData.granular_details.forEach(detail => {
                    if (!visitorGroups[detail.visitor_id]) {
                        visitorGroups[detail.visitor_id] = [];
                    }
                    visitorGroups[detail.visitor_id].push(detail);
                });
                
                let totalRows = 0;
                Object.values(visitorGroups).forEach(details => {
                    details.forEach(detail => {
                        totalRows += detail.visitor_pg_no.length;
                    });
                });
                
                html += `<p class="text-muted"><strong>${Object.keys(visitorGroups).length}</strong> unique visitors | <strong>${totalRows}</strong> total page views</p>`;
                
                Object.entries(visitorGroups).forEach(([visitorId, details]) => {
                    html += `
                        <div class="granular-card">
                            <h5 class="text-primary mb-3">
                                <span class="visitor-badge">${visitorId}</span>
                                <span class="text-muted small">(${details.length} session${details.length > 1 ? 's' : ''})</span>
                            </h5>
                            
                            <div class="table-responsive">
                                <table class="table table-bordered table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Visitor No</th>
                                            <th>Page No</th>
                                            <th>MCVID</th>
                                            <th>Agent ID</th>
                                            <th>Correlation ID</th>
                                            <th>URL Referral</th>
                                            <th>ContentSquare URL</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    // FIXED: Explode rows for each visitor_pg_no
                    details.forEach(detail => {
                        detail.visitor_pg_no.forEach((pgNo, idx) => {
                            html += `
                                <tr>
                                    <td><span class="badge bg-secondary">${detail.visitor_no}</span></td>
                                    <td><span class="badge bg-info text-dark">${pgNo}</span>

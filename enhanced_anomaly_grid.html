<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Intelligent Anomaly Grid</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-size: 0.95rem; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; text-align: center; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .panel { background-color: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); min-height: 75vh; }
        .sortable-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .sortable-header:hover { background-color: #e9ecef; }
        .page-link { cursor: pointer; }
        .filter-panel { background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: .5rem; padding: 1rem; }
        .multi-select-dropdown { position: relative; }
        .multi-select-button { width: 100%; font-size: .875rem; text-align: left; background-color: white; border: 1px solid #ced4da; padding: .35rem .75rem; border-radius: .375rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s; }
        .multi-select-button:hover { background-color: #f8f9fa; border-color: #86b7fe; }
        .multi-select-button::after { content: "▼"; font-size: 0.7rem; color: #6c757d; margin-left: .5rem; }
        .multi-select-menu { display: none; position: absolute; width: 100%; max-height: 280px; overflow-y: auto; background-color: white; border: 1px solid #ced4da; border-radius: .5rem; z-index: 1050; padding: .5rem; box-shadow: 0 8px 24px rgba(0,0,0,0.15); margin-top: 4px; }
        .multi-select-menu.show { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .multi-select-option { padding: .5rem; cursor: pointer; border-radius: .375rem; display: flex; align-items: center; transition: background-color 0.15s; }
        .multi-select-option:hover { background-color: #e9ecef; }
        .multi-select-option input[type="checkbox"] { margin-right: .6rem; cursor: pointer; }
        .multi-select-option.all-option { font-weight: 600; border-bottom: 1px solid #dee2e6; margin-bottom: .3rem; padding-bottom: .6rem; }
        .selected-count { color: #0d6efd; font-weight: 600; font-size: 0.85rem; }
        .annotated-row { background-color: #f0f9ff !important; font-style: italic; }
        .annotated-row td { color: #0369a1; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loading-overlay .spinner-border { width: 3rem; height: 3rem; }
        .loading-overlay p { color: white; margin-top: 1rem; font-size: 1.1rem; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9998; }
        .batch-toolbar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: .5rem; padding: 1rem; margin-bottom: 1rem; }
        .undo-redo-buttons { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .undo-redo-buttons button { margin-left: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border-width: 0; }
        .column-toggle-menu { max-height: 400px; overflow-y: auto; min-width: 200px; }
        .export-buttons .btn { margin-left: 0.5rem; }
        .filter-preset-badge { display: inline-block; background: #0d6efd; color: white; padding: .25rem .75rem; border-radius: 1rem; margin: .25rem; font-size: .85rem; cursor: pointer; }
        .filter-preset-badge:hover { background: #0b5ed7; }
        .filter-preset-badge .remove { margin-left: .5rem; font-weight: bold; }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay" style="display: none;">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p id="loading-message">Processing...</p>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Undo/Redo Buttons -->
    <div class="undo-redo-buttons">
        <button id="undo-btn" class="btn btn-secondary btn-sm" disabled title="Undo (Ctrl+Z)" aria-label="Undo last action">
            ↶ Undo
        </button>
        <button id="redo-btn" class="btn btn-secondary btn-sm" disabled title="Redo (Ctrl+Shift+Z)" aria-label="Redo last action">
            ↷ Redo
        </button>
    </div>

    <div class="header">
        <h1>🚀 Enhanced Intelligent Anomaly Grid</h1>
        <p class="lead mb-0">Production-Ready with 20+ Advanced Features</p>
    </div>

    <div class="container-fluid px-4">
        <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="explorer-tab" data-bs-toggle="tab" data-bs-target="#explorer-pane" type="button" role="tab" aria-controls="explorer-pane" aria-selected="true">
                    Annotation Explorer
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="granular-tab" data-bs-toggle="tab" data-bs-target="#granular-pane" type="button" role="tab" aria-controls="granular-pane" aria-selected="false">
                    Granular Details
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="log-tab" data-bs-toggle="tab" data-bs-target="#log-pane" type="button" role="tab" aria-controls="log-pane" aria-selected="false">
                    Annotation Log
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics-pane" type="button" role="tab" aria-controls="analytics-pane" aria-selected="false">
                    Analytics
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Explorer Tab -->
            <div class="tab-pane fade show active" id="explorer-pane" role="tabpanel" aria-labelledby="explorer-tab">
                <div class="row g-4">
                    <div class="col-md-3">
                        <div class="panel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">Path Explorer</h4>
                                <button class="btn btn-sm btn-outline-primary" id="enter-batch-mode-btn" title="Select multiple records">
                                    Batch Mode
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small">Filter Week Number</label>
                                <div id="week-filter-container"></div>
                            </div>
                            
                            <div class="border-top pt-3">
                                <p class="small text-muted">Check paths to view records</p>
                                <div id="paths-list-container" style="max-height: 60vh; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-9">
                        <div class="panel">
                            <!-- Batch Toolbar -->
                            <div id="batch-toolbar" class="batch-toolbar" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span id="batch-count" class="fw-bold fs-5">0 selected</span>
                                        <button class="btn btn-sm btn-light ms-3" id="batch-select-all">Select All</button>
                                        <button class="btn btn-sm btn-light ms-1" id="batch-deselect-all">Deselect All</button>
                                    </div>
                                    <div>
                                        <select id="batch-annotation-select" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                            <option value="">Choose classification...</option>
                                        </select>
                                        <button class="btn btn-sm btn-success ms-2" id="batch-apply-btn">Apply to Selected</button>
                                        <button class="btn btn-sm btn-secondary ms-1" id="exit-batch-mode-btn">Exit Batch Mode</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Toolbar -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div class="export-buttons">
                                    <button class="btn btn-sm btn-outline-success" id="export-csv-btn" title="Export to CSV">
                                        📊 Export CSV
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" id="export-json-btn" title="Export to JSON">
                                        📄 Export JSON
                                    </button>
                                </div>
                                <div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            Columns
                                        </button>
                                        <ul class="dropdown-menu column-toggle-menu" id="column-toggle-menu"></ul>
                                    </div>
                                    <div class="btn-group ms-2">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                            Saved Filters
                                        </button>
                                        <ul class="dropdown-menu" id="filter-presets-menu">
                                            <li><a class="dropdown-item" href="#" id="save-filter-preset">💾 Save Current Filters</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><span class="dropdown-item text-muted" id="no-presets-msg">No saved filters</span></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <div id="details-container">
                                <div class="text-center p-5">
                                    <p class="text-muted">Select one or more paths from the left to begin.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Granular Tab -->
            <div class="tab-pane fade" id="granular-pane" role="tabpanel" aria-labelledby="granular-tab">
                <div class="panel" style="max-height: 80vh; overflow-y: auto;">
                    <div id="granular-details-content">
                        <div class="text-center p-5">
                            <p class="text-muted">Click on any row in the Annotation Explorer to view granular details.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Log Tab -->
            <div class="tab-pane fade" id="log-pane" role="tabpanel" aria-labelledby="log-tab">
                <div class="panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4>Annotation Log</h4>
                        <button class="btn btn-sm btn-outline-danger" id="clear-all-annotations-btn">
                            Clear All Annotations
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead id="log-table-head"></thead>
                            <tbody id="log-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="tab-pane fade" id="analytics-pane" role="tabpanel" aria-labelledby="analytics-tab">
                <div class="panel">
                    <h4 class="mb-3">Analytics Dashboard</h4>
                    <div id="analytics-content">
                        <div class="text-center p-5">
                            <p class="text-muted">No annotation data available. Please classify some records first.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
    'use strict';

    // ==================== CONFIGURATION ====================
    const CONFIG = {
        ROWS_PER_PAGE: 10,
        STORAGE_KEY: 'anomaly_grid_v1',
        ANNOTATION_STORAGE_KEY: 'anomaly_annotations_v1',
        FILTER_PRESETS_KEY: 'filter_presets_v1',
        COLUMN_PREFS_KEY: 'column_preferences_v1',
        MAX_HISTORY: 50,
        DEBOUNCE_DELAY: 250,
        FILTERABLE_COLUMNS: ["Journey type", "Team", "Business Unit", "Device", "Completed", "hard anomaly"],
        ANNOTATION_CATEGORIES: ["System Error", "Data Glitch", "User Error", "Expected Behavior", "Fraudulent Activity", "Test/QA Activity", "Needs Investigation"],
        DISPLAY_COLUMNS: ["row_id", "Week number", "path", "Journey type", "Team", "Business Unit", "Device", "Completed", "hard anomaly", "Annotation", "Comment"],
        LOG_DISPLAY_COLUMNS: ["row_id", "Week number", "path", "Journey type", "Team", "Business Unit", "Device", "Completed", "hard anomaly", "Annotation", "Comment", "Timestamp"]
    };

    // ==================== UTILITY FUNCTIONS ====================
    
    // XSS Protection - Escape HTML
    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        const div = document.createElement('div');
        div.textContent = String(unsafe);
        return div.innerHTML;
    }

    // Input Validation
    function validateAnnotation(data) {
        const errors = [];
        
        if (!data.row_id || typeof data.row_id !== 'string') {
            errors.push('Invalid row_id');
        }
        
        if (!data.Annotation || !CONFIG.ANNOTATION_CATEGORIES.includes(data.Annotation)) {
            errors.push('Invalid annotation category');
        }
        
        if (data.Comment && data.Comment.length > 500) {
            errors.push('Comment too long (max 500 characters)');
        }
        
        return {
            valid: errors.length === 0,
            errors
        };
    }

    // Sanitize Input
    function sanitizeInput(input) {
        if (!input) return '';
        return String(input)
            .trim()
            .replace(/[<>]/g, '')
            .substring(0, 500);
    }

    // Debouncer
    class Debouncer {
        constructor(delay = CONFIG.DEBOUNCE_DELAY) {
            this.delay = delay;
            this.timeouts = new Map();
        }
        
        debounce(key, callback) {
            if (this.timeouts.has(key)) {
                clearTimeout(this.timeouts.get(key));
            }
            
            const timeout = setTimeout(() => {
                callback();
                this.timeouts.delete(key);
            }, this.delay);
            
            this.timeouts.set(key, timeout);
        }
    }

    const debouncer = new Debouncer();

    // ==================== UI HELPERS ====================
    
    class UIHelpers {
        static showLoading(message = 'Processing...') {
            const overlay = document.getElementById('loading-overlay');
            const messageEl = document.getElementById('loading-message');
            messageEl.textContent = message;
            overlay.style.display = 'flex';
            this.announceToScreenReader(message);
        }
        
        static hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
        
        static showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            
            const bgClass = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning',
                'info': 'bg-info'
            }[type] || 'bg-success';
            
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-white ${bgClass} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${escapeHtml(message)}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            container.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
            
            this.announceToScreenReader(message);
        }
        
        static announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('role', 'status');
            announcement.setAttribute('aria-live', 'polite');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            setTimeout(() => announcement.remove(), 1000);
        }
    }

    // ==================== STORAGE MANAGER ====================
    
    class StorageManager {
        static save(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    console.error('Storage quota exceeded');
                    UIHelpers.showToast('Storage quota exceeded. Please export your data.', 'error');
                }
                return false;
            }
        }
        
        static load(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                console.error('Failed to load from storage:', e);
                return defaultValue;
            }
        }
        
        static remove(key) {
            try {
                localStorage.removeItem(key);
                return true;
            } catch (e) {
                console.error('Failed to remove from storage:', e);
                return false;
            }
        }
    }

    // ==================== HISTORY MANAGER (UNDO/REDO) ====================
    
    class HistoryManager {
        constructor() {
            this.history = [];
            this.currentIndex = -1;
            this.maxHistory = CONFIG.MAX_HISTORY;
        }
        
        push(state) {
            this.history = this.history.slice(0, this.currentIndex + 1);
            this.history.push(JSON.parse(JSON.stringify(state)));
            this.currentIndex++;
            
            if (this.history.length > this.maxHistory) {
                this.history.shift();
                this.currentIndex--;
            }
            
            this.updateUI();
        }
        
        undo() {
            if (this.canUndo()) {
                this.currentIndex--;
                this.updateUI();
                return this.getCurrentState();
            }
            return null;
        }
        
        redo() {
            if (this.canRedo()) {
                this.currentIndex++;
                this.updateUI();
                return this.getCurrentState();
            }
            return null;
        }
        
        canUndo() {
            return this.currentIndex > 0;
        }
        
        canRedo() {
            return this.currentIndex < this.history.length - 1;
        }
        
        getCurrentState() {
            return JSON.parse(JSON.stringify(this.history[this.currentIndex]));
        }
        
        updateUI() {
            document.getElementById('undo-btn').disabled = !this.canUndo();
            document.getElementById('redo-btn').disabled = !this.canRedo();
        }
    }

    // ==================== DATA EXPORT ====================
    
    class DataExporter {
        static exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                UIHelpers.showToast('No data to export', 'warning');
                return;
            }
            
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => 
                    headers.map(h => this.escapeCSV(row[h])).join(',')
                )
            ].join('\n');
            
            this.downloadFile(csv, filename, 'text/csv');
            UIHelpers.showToast(`Exported ${data.length} records to CSV`, 'success');
        }
        
        static exportToJSON(data, filename) {
            if (!data || data.length === 0) {
                UIHelpers.showToast('No data to export', 'warning');
                return;
            }
            
            const json = JSON.stringify(data, null, 2);
            this.downloadFile(json, filename, 'application/json');
            UIHelpers.showToast(`Exported ${data.length} records to JSON`, 'success');
        }
        
        static escapeCSV(value) {
            if (value === null || value === undefined) return '';
            const str = String(value);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        }
        
        static downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    }

    // ==================== FILTER PRESETS ====================
    
    class FilterPresets {
        constructor() {
            this.presets = StorageManager.load(CONFIG.FILTER_PRESETS_KEY, []);
        }
        
        save(name, filters) {
            const preset = {
                id: Date.now(),
                name,
                filters: Object.fromEntries(
                    Object.entries(filters).map(([k, v]) => [k, Array.from(v)])
                ),
                createdAt: new Date().toISOString()
            };
            
            this.presets.push(preset);
            StorageManager.save(CONFIG.FILTER_PRESETS_KEY, this.presets);
            return preset;
        }
        
        delete(id) {
            this.presets = this.presets.filter(p => p.id !== id);
            StorageManager.save(CONFIG.FILTER_PRESETS_KEY, this.presets);
        }
        
        apply(id) {
            const preset = this.presets.find(p => p.id === id);
            if (!preset) return null;
            
            return Object.fromEntries(
                Object.entries(preset.filters).map(([k, v]) => [k, new Set(v)])
            );
        }
        
        getAll() {
            return this.presets;
        }
    }

    // ==================== COLUMN MANAGER ====================
    
    class ColumnManager {
        constructor(allColumns) {
            this.allColumns = allColumns;
            this.visibleColumns = new Set(
                StorageManager.load(CONFIG.COLUMN_PREFS_KEY, allColumns)
            );
        }
        
        toggle(column) {
            if (this.visibleColumns.has(column)) {
                this.visibleColumns.delete(column);
            } else {
                this.visibleColumns.add(column);
            }
            StorageManager.save(CONFIG.COLUMN_PREFS_KEY, Array.from(this.visibleColumns));
        }
        
        isVisible(column) {
            return this.visibleColumns.has(column);
        }
        
        getVisible() {
            return this.allColumns.filter(col => this.visibleColumns.has(col));
        }
    }

    // ==================== BATCH OPERATIONS ====================
    
    class BatchOperations {
        constructor() {
            this.selectedRows = new Set();
            this.batchMode = false;
        }
        
        enterBatchMode() {
            this.batchMode = true;
            this.selectedRows.clear();
            document.getElementById('batch-toolbar').style.display = 'block';
            document.getElementById('batch-count').textContent = '0 selected';
            UIHelpers.announceToScreenReader('Batch mode activated');
        }
        
        exitBatchMode() {
            this.batchMode = false;
            this.selectedRows.clear();
            document.getElementById('batch-toolbar').style.display = 'none';
            app.updateGridView();
            UIHelpers.announceToScreenReader('Batch mode deactivated');
        }
        
        toggle(rowId) {
            if (this.selectedRows.has(rowId)) {
                this.selectedRows.delete(rowId);
            } else {
                this.selectedRows.add(rowId);
            }
            this.updateCount();
        }
        
        selectAll(rows) {
            rows.forEach(row => this.selectedRows.add(row.row_id));
            this.updateCount();
            app.updateGridView();
        }
        
        deselectAll() {
            this.selectedRows.clear();
            this.updateCount();
            app.updateGridView();
        }
        
        updateCount() {
            document.getElementById('batch-count').textContent = `${this.selectedRows.size} selected`;
        }
        
        async applyBatch(annotation, comment) {
            if (this.selectedRows.size === 0) {
                UIHelpers.showToast('No records selected', 'warning');
                return;
            }
            
            UIHelpers.showLoading(`Processing ${this.selectedRows.size} records...`);
            
            try {
                let successCount = 0;
                
                for (const rowId of this.selectedRows) {
                    const row = app.currentDetailRecords.find(r => r.row_id === rowId);
                    if (row && !app.annotationLog.some(log => log.row_id === rowId)) {
                        const logEntry = {
                            ...row,
                            Annotation: annotation,
                            Comment: comment,
                            Timestamp: new Date().toISOString()
                        };
                        
                        app.annotationLog.push(logEntry);
                        successCount++;
                    }
                }
                
                app.saveAnnotations();
                app.updateLogView();
                app.updateGridView();
                this.exitBatchMode();
                
                UIHelpers.showToast(`Successfully annotated ${successCount} records`, 'success');
                
            } catch (error) {
                console.error('Batch operation failed:', error);
                UIHelpers.showToast('Batch operation failed', 'error');
            } finally {
                UIHelpers.hideLoading();
            }
        }
    }

    // ==================== SAMPLE DATA ====================
    
    const SAMPLE_DATA = [
        { 
            "row_id": 'a1', "Week number": 40, "path": '/home', "Journey type": "Basic", 
            "Team": "US", "Business Unit": "Consumer", "Device": "mobile", 
            "Completed": "yes", "hard anomaly": "false",
            "granular_details": [
                {
                    visitor_id: "V00123", visitor_no: 1, visitor_pg_no: [3, 4, 8, 57],
                    mcvid: "MCVID_ABC123", agent_id: "AG_001", correlation_id: "CORR_XYZ789",
                    URL_Referral: "https://google.com/search?q=product",
                    ContentSquare_URL_Link: "https://contentsquare.com/session/abc123"
                },
                {
                    visitor_id: "V00124", visitor_no: 1, visitor_pg_no: [1, 2, 5, 10, 12],
                    mcvid: "MCVID_ABC124", agent_id: "AG_001", correlation_id: "CORR_XYZ790",
                    URL_Referral: "https://facebook.com/ad/campaign",
                    ContentSquare_URL_Link: "https://contentsquare.com/session/abc124"
                }
            ]
        },
        { 
            "row_id": 'a2', "Week number": 40, "path": '/home', "Journey type": "Upgraded", 
            "Team": "US", "Business Unit": "PL", "Device": "PC", 
            "Completed": "no", "hard anomaly": "true",
            "granular_details": [
                {
                    visitor_id: "V00225", visitor_no: 1, visitor_pg_no: [2, 5, 7],
                    mcvid: "MCVID_DEF456", agent_id: "AG_003", correlation_id: "CORR_ABC001",
                    URL_Referral: "https://linkedin.com/posts/tech",
                    ContentSquare_URL_Link: "https://contentsquare.com/session/def456"
                }
            ]
        },
        { 
            "row_id": 'b1', "Week number": 41, "path": '/home', "Journey type": "Basic", 
            "Team": "India", "Business Unit": "Consumer", "Device": "mobile", 
            "Completed": "yes", "hard anomaly": "false",
            "granular_details": [
                {
                    visitor_id: "V00326", visitor_no: 1, visitor_pg_no: [1, 3, 5, 8, 12, 15],
                    mcvid: "MCVID_GHI789", agent_id: "AG_004", correlation_id: "CORR_ABC002",
                    URL_Referral: "https://twitter.com/ad/promo",
                    ContentSquare_URL_Link: "https://contentsquare.com/session/ghi789"
                }
            ]
        },
        { 
            "row_id": 'c1', "Week number": 41, "path": '/products', "Journey type": null, 
            "Team": "US", "Business Unit": "sbs", "Device": "desktop", 
            "Completed": "yes", "hard anomaly": "false",
            "granular_details": [
                {
                    visitor_id: "V00428", visitor_no: 1, visitor_pg_no: [10, 15, 20, 25],
                    mcvid: "MCVID_JKL012", agent_id: "AG_005", correlation_id: "CORR_ABC004",
                    URL_Referral: "https://reddit.com/r/technology",
                    ContentSquare_URL_Link: "https://contentsquare.com/session/jkl012"
                }
            ]
        },
        { 
            "row_id": 'c2', "Week number": 42, "path": '/products', "Journey type": "Upgraded", 
            "Team": "India", "Business Unit": "PL", "Device": null, 
            "Completed": "no", "hard anomaly": "true",
            "granular_details": [
                {
                    visitor_id: "V00529", visitor_no: 1, visitor_pg_no: [5, 10, 15, 20, 25, 30],
                    mcvid: "MCVID_MNO345", agent_id: "AG_006", correlation_id: "CORR_ABC005",
                    URL_Referral: "https://instagram.com/ad/story",
                    ContentSquare_URL_Link: "https://contentsquare.com/session/mno345"
                }
            ]
        },
        ...Array.from({length: 50}, (_, i) => ({ 
            "row_id": `z${i}`, 
            "Week number": 40 + (i%3), 
            "path": '/checkout', 
            "Journey type": ["Basic", "Upgraded", null][i%3], 
            "Team": ["US", "India"][i%2], 
            "Business Unit": ["Consumer", "sbs", "PL"][i%3], 
            "Device": ["mobile", "PC", null][i%3], 
            "Completed": ["yes", "no"][i%2], 
            "hard anomaly": ["true", "false"][i%2],
            "granular_details": [
                {
                    visitor_id: `V${String(i + 600).padStart(5, '0')}`,
                    visitor_no: 1,
                    visitor_pg_no: [1, 2, 3, 5, 8, 13].slice(0, (i % 4) + 2),
                    mcvid: `MCVID_Z${String(i).padStart(3, '0')}`,
                    agent_id: `AG_${String((i % 10) + 1).padStart(3, '0')}`,
                    correlation_id: `CORR_Z${String(i).padStart(3, '0')}`,
                    URL_Referral: `https://example.com/ref${i}`,
                    ContentSquare_URL_Link: `https://contentsquare.com/session/z${i}`
                }
            ]
        }))
    ];

    // ==================== MAIN APPLICATION ====================
    
    class AnomalyGridApp {
        constructor() {
            this.appData = SAMPLE_DATA;
            this.annotationLog = StorageManager.load(CONFIG.ANNOTATION_STORAGE_KEY, []);
            this.currentDetailRecords = [];
            this.selectedRowForAnnotation = null;
            this.selectedPaths = new Set();
            this.selectedWeeks = new Set();
            this.allWeeks = [];
            
            this.gridState = {
                filters: {},
                sortColumn: 'row_id',
                sortDirection: 'asc',
                currentPage: 1
            };
            
            this.historyManager = new HistoryManager();
            this.filterPresets = new FilterPresets();
            this.columnManager = new ColumnManager(CONFIG.DISPLAY_COLUMNS);
            this.batchOps = new BatchOperations();
            this.chartInstances = {};
            
            this.init();
        }
        
        init() {
            try {
                // Initialize weeks
                this.allWeeks = [...new Set(this.appData.map(d => d['Week number']))].sort((a,b) => a - b);
                this.selectedWeeks = new Set(this.allWeeks);
                
                // Render initial UI
                this.renderWeekFilter();
                this.updatePathExplorer();
                this.updateLogView();
                this.renderColumnToggle();
                this.renderFilterPresets();
                this.populateBatchAnnotationDropdown();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Initialize history
                this.historyManager.push(this.annotationLog);
                
                // Setup keyboard shortcuts
                this.setupKeyboardShortcuts();
                
                UIHelpers.showToast('Application loaded successfully', 'success');
            } catch (error) {
                console.error('Initialization failed:', error);
                UIHelpers.showToast('Failed to initialize application', 'error');
            }
        }
        
        setupEventListeners() {
            // Week filter changes
            document.getElementById('week-filter-container').addEventListener('change', (e) => {
                if (e.target.classList.contains('week-filter-checkbox')) {
                    this.handleWeekFilterChange(e.target);
                }
            });
            
            // Path selection changes
            document.getElementById('paths-list-container').addEventListener('change', (e) => {
                if (e.target.id === 'path-select-all' || e.target.classList.contains('path-checkbox')) {
                    this.handlePathSelection(e.target);
                }
            });
            
            // Multi-select dropdowns
            document.addEventListener('click', (e) => {
                const button = e.target.closest('.multi-select-button');
                if (button) {
                    e.stopPropagation();
                    const menu = button.nextElementSibling;
                    const isOpen = menu.classList.contains('show');
                    document.querySelectorAll('.multi-select-menu').forEach(m => m.classList.remove('show'));
                    if (!isOpen) menu.classList.add('show');
                }
                
                if (!e.target.closest('.multi-select-dropdown')) {
                    document.querySelectorAll('.multi-select-menu').forEach(menu => menu.classList.remove('show'));
                }
            });
            
            // Filter changes
            document.getElementById('details-container').addEventListener('change', (e) => {
                if (e.target.classList.contains('multi-select-checkbox')) {
                    this.handleFilterChange(e.target);
                }
            });
            
            // Grid interactions
            document.getElementById('details-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('page-link') && !e.target.parentElement.classList.contains('disabled')) {
                    this.gridState.currentPage = parseInt(e.target.dataset.page);
                    this.updateGridView();
                } else if (e.target.classList.contains('sortable-header')) {
                    this.handleSort(e.target.dataset.column);
                } else if (e.target.closest('tr')?.closest('tbody')?.id === 'details-table-body') {
                    this.handleRowClick(e.target.closest('tr'));
                } else if (e.target.id === 'submit-annotation-btn') {
                    this.handleAnnotation();
                } else if (e.target.classList.contains('batch-checkbox')) {
                    this.batchOps.toggle(e.target.dataset.rowId);
                    this.updateGridView();
                }
            });
            
            // Annotation dropdown change
            document.getElementById('details-container').addEventListener('change', (e) => {
                if (e.target.id === 'annotation-dropdown') {
                    document.getElementById('submit-annotation-btn').disabled = !e.target.value;
                }
            });
            
            // Export buttons
            document.getElementById('export-csv-btn').addEventListener('click', () => {
                DataExporter.exportToCSV(this.annotationLog, `annotations_${new Date().toISOString().split('T')[0]}.csv`);
            });
            
            document.getElementById('export-json-btn').addEventListener('click', () => {
                DataExporter.exportToJSON(this.annotationLog, `annotations_${new Date().toISOString().split('T')[0]}.json`);
            });
            
            // Batch mode buttons
            document.getElementById('enter-batch-mode-btn').addEventListener('click', () => {
                this.batchOps.enterBatchMode();
                this.updateGridView();
            });
            
            document.getElementById('exit-batch-mode-btn').addEventListener('click', () => {
                this.batchOps.exitBatchMode();
            });
            
            document.getElementById('batch-select-all').addEventListener('click', () => {
                this.batchOps.selectAll(this.getCurrentPageRecords());
            });
            
            document.getElementById('batch-deselect-all').addEventListener('click', () => {
                this.batchOps.deselectAll();
            });
            
            document.getElementById('batch-apply-btn').addEventListener('click', () => {
                const annotation = document.getElementById('batch-annotation-select').value;
                if (!annotation) {
                    UIHelpers.showToast('Please select a classification', 'warning');
                    return;
                }
                const comment = prompt('Enter an optional comment for all selected records:');
                this.batchOps.applyBatch(annotation, comment || '');
            });
            
            // Undo/Redo buttons
            document.getElementById('undo-btn').addEventListener('click', () => this.undo());
            document.getElementById('redo-btn').addEventListener('click', () => this.redo());
            
            // Filter presets
            document.getElementById('save-filter-preset').addEventListener('click', (e) => {
                e.preventDefault();
                this.saveFilterPreset();
            });
            
            // Clear all annotations
            document.getElementById('clear-all-annotations-btn').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all annotations? This cannot be undone.')) {
                    this.clearAllAnnotations();
                }
            });
            
            // Analytics tab shown
            document.getElementById('analytics-tab').addEventListener('shown.bs.tab', () => {
                this.renderAnalytics();
            });
        }
        
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Undo: Ctrl+Z
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    this.undo();
                }
                
                // Redo: Ctrl+Shift+Z or Ctrl+Y
                if ((e.ctrlKey || e.metaKey) && (e.shiftKey && e.key === 'z' || e.key === 'y')) {
                    e.preventDefault();
                    this.redo();
                }
                
                // Export: Ctrl+E
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    DataExporter.exportToCSV(this.annotationLog, `annotations_${new Date().toISOString().split('T')[0]}.csv`);
                }
            });
        }
        
        // ==================== WEEK FILTER ====================
        
        renderWeekFilter() {
            const container = document.getElementById('week-filter-container');
            
            let html = `
                <div class="multi-select-dropdown">
                    <div class="multi-select-button" data-column="week_number" aria-label="Filter by week number" role="button" tabindex="0">
                        <span>All Weeks</span>
                    </div>
                    <div class="multi-select-menu" role="listbox">
                        <div class="multi-select-option all-option">
                            <input type="checkbox" class="week-filter-checkbox" value="__ALL__" id="all-weeks" checked>
                            <label for="all-weeks" style="cursor:pointer; margin:0; flex:1;">Select All</label>
                        </div>
                        ${this.allWeeks.map((value, idx) => {
                            const valueId = `week-${idx}`;
                            return `
                                <div class="multi-select-option">
                                    <input type="checkbox" class="week-filter-checkbox" value="${value}" id="${valueId}" checked>
                                    <label for="${valueId}" style="cursor:pointer; margin:0; flex:1;">Week ${value}</label>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        handleWeekFilterChange(checkbox) {
            const value = checkbox.value;
            
            if (value === '__ALL__') {
                if (checkbox.checked) {
                    this.allWeeks.forEach(w => this.selectedWeeks.add(w));
                    document.querySelectorAll('.week-filter-checkbox').forEach(cb => cb.checked = true);
                } else {
                    this.selectedWeeks.clear();
                    document.querySelectorAll('.week-filter-checkbox').forEach(cb => cb.checked = false);
                }
            } else {
                const weekNum = parseInt(value);
                if (checkbox.checked) {
                    this.selectedWeeks.add(weekNum);
                } else {
                    this.selectedWeeks.delete(weekNum);
                }
                
                const allChecked = this.selectedWeeks.size === this.allWeeks.length;
                document.getElementById('all-weeks').checked = allChecked;
            }
            
            this.updateWeekFilterDisplay();
            this.updatePathExplorer();
        }
        
        updateWeekFilterDisplay() {
            const button = document.querySelector('[data-column="week_number"]');
            if (!button) return;
            
            const span = button.querySelector('span');
            const count = this.selectedWeeks.size;
            
            if (count === this.allWeeks.length) {
                span.textContent = 'All Weeks';
                span.className = '';
            } else if (count === 0) {
                span.textContent = 'None selected';
                span.className = 'text-muted';
            } else {
                span.textContent = `${count} week(s) selected`;
                span.className = 'selected-count';
            }
        }
        
        // ==================== PATH EXPLORER ====================
        
        updatePathExplorer() {
            this.selectedPaths.clear();
            
            const filteredData = this.appData.filter(row => this.selectedWeeks.has(row['Week number']));
            const pathCounts = filteredData.reduce((acc, {path}) => {
                acc[path] = (acc[path] || 0) + 1;
                return acc;
            }, {});
            
            const container = document.getElementById('paths-list-container');
            
            if (Object.keys(pathCounts).length === 0) {
                container.innerHTML = `<div class="text-muted small">No paths found for selected weeks.</div>`;
                this.loadDetailsForSelectedPaths();
                return;
            }
            
            let html = `
                <div class="form-check fw-bold border-bottom pb-2 mb-2">
                    <input class="form-check-input" type="checkbox" id="path-select-all">
                    <label class="form-check-label" for="path-select-all">Select All</label>
                </div>
            `;
            
            Object.entries(pathCounts).sort((a, b) => a[0].localeCompare(b[0])).forEach(([path, count]) => {
                const pathId = `path-${path.replace(/[^a-zA-Z0-9]/g, '')}`;
                html += `
                    <div class="form-check">
                        <input class="form-check-input path-checkbox" type="checkbox" value="${escapeHtml(path)}" id="${pathId}">
                        <label class="form-check-label" for="${pathId}">
                            ${escapeHtml(path)} <span class="text-muted">(${count})</span>
                        </label>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            this.loadDetailsForSelectedPaths();
        }
        
        handlePathSelection(checkbox) {
            if (checkbox.id === 'path-select-all') {
                document.querySelectorAll('.path-checkbox').forEach(cb => {
                    cb.checked = checkbox.checked;
                    if (checkbox.checked) {
                        this.selectedPaths.add(cb.value);
                    } else {
                        this.selectedPaths.delete(cb.value);
                    }
                });
            } else {
                if (checkbox.checked) {
                    this.selectedPaths.add(checkbox.value);
                } else {
                    this.selectedPaths.delete(checkbox.value);
                }
                
                const allChecked = [...document.querySelectorAll('.path-checkbox')].every(c => c.checked);
                document.getElementById('path-select-all').checked = allChecked;
            }
            
            debouncer.debounce('path-selection', () => {
                this.loadDetailsForSelectedPaths();
            });
        }
        
        loadDetailsForSelectedPaths() {
            if (this.selectedPaths.size === 0) {
                document.getElementById('details-container').innerHTML = `
                    <div class="text-center p-5">
                        <p class="text-muted">Select one or more paths from the left to begin.</p>
                    </div>
                `;
                return;
            }
            
            this.currentDetailRecords = this.appData.filter(row => 
                this.selectedWeeks.has(row['Week number']) && this.selectedPaths.has(row.path)
            );
            
            this.gridState = {
                filters: {},
                sortColumn: 'row_id',
                sortDirection: 'asc',
                currentPage: 1
            };
            
            this.renderDetailsView();
        }
        
        // ==================== GRID VIEW ====================
        
        renderDetailsView() {
            const annotationMap = new Map(this.annotationLog.map(log => [log.row_id, log]));
            const enrichedData = this.currentDetailRecords.map(row => {
                const logEntry = annotationMap.get(row.row_id);
                return {
                    ...row,
                    Annotation: logEntry ? logEntry.Annotation : null,
                    Comment: logEntry ? logEntry.Comment : null
                };
            });
            
            // Build filter options
            const filterOptions = {};
            CONFIG.FILTERABLE_COLUMNS.forEach(col => {
                const values = [...new Set(enrichedData.map(row => row[col]))].sort();
                filterOptions[col] = values;
            });
            
            // Render filter panel
            let filterPanelHTML = '<div class="filter-panel mb-3 row g-3">';
            for (const [column, values] of Object.entries(filterOptions)) {
                const columnId = column.replace(/\s+/g, '_');
                filterPanelHTML += `
                    <div class="col-md-2">
                        <label class="form-label fw-bold small">${escapeHtml(column)}</label>
                        <div class="multi-select-dropdown">
                            <div class="multi-select-button" data-column="${escapeHtml(column)}" role="button" tabindex="0" aria-label="Filter by ${escapeHtml(column)}">
                                <span>All</span>
                            </div>
                            <div class="multi-select-menu" role="listbox">
                                <div class="multi-select-option all-option">
                                    <input type="checkbox" class="multi-select-checkbox" data-column="${escapeHtml(column)}" value="__ALL__" id="all-${columnId}" checked>
                                    <label for="all-${columnId}" style="cursor:pointer; margin:0; flex:1;">Select All</label>
                                </div>
                                ${values.map((value, idx) => {
                                    const displayValue = value === null ? '(Blank)' : escapeHtml(String(value));
                                    const valueId = `${columnId}-${idx}`;
                                    return `
                                        <div class="multi-select-option">
                                            <input type="checkbox" class="multi-select-checkbox" data-column="${escapeHtml(column)}" value="${escapeHtml(String(value))}" id="${valueId}">
                                            <label for="${valueId}" style="cursor:pointer; margin:0; flex:1;">${displayValue}</label>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            filterPanelHTML += '</div>';
            
            // Populate batch annotation dropdown
            const batchSelect = document.getElementById('batch-annotation-select');
            batchSelect.innerHTML = `<option value="">Choose classification...</option>` +
                CONFIG.ANNOTATION_CATEGORIES.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
            
            // Render container
            document.getElementById('details-container').innerHTML = `
                ${filterPanelHTML}
                <div id="grid-summary" class="text-muted small mb-2" role="status" aria-live="polite"></div>
                <div class="table-responsive" style="max-height: 50vh; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead id="details-table-head" class="sticky-top bg-light"></thead>
                        <tbody id="details-table-body"></tbody>
                    </table>
                </div>
                <nav aria-label="Pagination">
                    <div id="pagination-controls" class="d-flex justify-content-center mt-3"></div>
                </nav>
                <div id="annotation-controls" class="mt-4 pt-3 border-top">
                    <h5 class="mb-3">Classify Anomaly</h5>
                    <div id="annotation-alert-spot" class="mb-2" role="alert" aria-live="polite"></div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="annotation-dropdown" class="form-label">Classification *</label>
                            <select id="annotation-dropdown" class="form-select" disabled aria-required="true">
                                <option value="">Choose a classification...</option>
                                ${CONFIG.ANNOTATION_CATEGORIES.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label for="comment-input" class="form-label">Comment (max 500 characters)</label>
                            <textarea class="form-control" id="comment-input" rows="2" maxlength="500" placeholder="Add an optional comment..." disabled aria-describedby="comment-help"></textarea>
                            <small id="comment-help" class="form-text text-muted">Optional description or notes</small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end mt-3">
                        <button id="submit-annotation-btn" class="btn btn-primary" disabled>
                            Submit Classification
                        </button>
                    </div>
                </div>
            `;
            
            this.updateGridView();
        }
        
        updateGridView() {
            UIHelpers.showLoading('Filtering data...');
            
            setTimeout(() => {
                try {
                    let processedData = this.filterData(this.currentDetailRecords);
                    processedData = this.sortData(processedData);
                    
                    const totalRecords = processedData.length;
                    const startRecord = totalRecords === 0 ? 0 : (this.gridState.currentPage - 1) * CONFIG.ROWS_PER_PAGE + 1;
                    const endRecord = Math.min(startRecord + CONFIG.ROWS_PER_PAGE - 1, totalRecords);
                    
                    const summaryEl = document.getElementById('grid-summary');
                    if (summaryEl) {
                        summaryEl.textContent = totalRecords > 0 ?
                            `Showing ${startRecord}-${endRecord} of ${totalRecords} records.` :
                            'No records match your filters.';
                    }
                    
                    this.renderTablePage(processedData);
                    this.renderPaginationControls(totalRecords);
                    
                    UIHelpers.announceToScreenReader(`Showing ${totalRecords} records`);
                } catch (error) {
                    console.error('Grid update failed:', error);
                    UIHelpers.showToast('Failed to update grid', 'error');
                } finally {
                    UIHelpers.hideLoading();
                }
            }, 50);
        }
        
        filterData(data) {
            return data.filter(row => {
                return Object.entries(this.gridState.filters).every(([column, selectedValues]) => {
                    if (!selectedValues || selectedValues.size === 0) return true;
                    return selectedValues.has(String(row[column]));
                });
            });
        }
        
        sortData(data) {
            return [...data].sort((a, b) => {
                const valA = a[this.gridState.sortColumn];
                const valB = b[this.gridState.sortColumn];
                
                if (valA === null || valA === undefined) return 1;
                if (valB === null || valB === undefined) return -1;
                
                if (valA < valB) return this.gridState.sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return this.gridState.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }
        
        renderTablePage(data) {
            const tableHead = document.getElementById('details-table-head');
            const tableBody = document.getElementById('details-table-body');
            
            if (!tableHead || !tableBody) return;
            
            const visibleColumns = this.columnManager.getVisible();
            const start = (this.gridState.currentPage - 1) * CONFIG.ROWS_PER_PAGE;
            const paginatedItems = data.slice(start, start + CONFIG.ROWS_PER_PAGE);
            
            // Render header
            let headerHTML = '<tr>';
            if (this.batchOps.batchMode) {
                headerHTML += '<th><input type="checkbox" id="select-all-page" aria-label="Select all on page"></th>';
            }
            headerHTML += visibleColumns.map(h => {
                if (h === 'Annotation' || h === 'Comment') {
                    return `<th scope="col">${escapeHtml(h)}</th>`;
                }
                const arrow = this.gridState.sortColumn === h ?
                    (this.gridState.sortDirection === 'asc' ? ' ▲' : ' ▼') : '';
                return `<th scope="col" class="sortable-header" data-column="${escapeHtml(h)}" role="button" tabindex="0" aria-label="Sort by ${escapeHtml(h)}">${escapeHtml(h)}${arrow}</th>`;
            }).join('');
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;
            
            // Render body
            tableBody.innerHTML = paginatedItems.map(rec => {
                const logEntry = this.annotationLog.find(log => log.row_id === rec.row_id);
                const annotatedClass = logEntry ? 'annotated-row' : '';
                const isSelected = this.batchOps.selectedRows.has(rec.row_id);
                
                let rowHTML = `<tr class="${annotatedClass}" style="cursor:pointer" data-row-id="${escapeHtml(rec.row_id)}" title="Click to view granular details">`;
                
                if (this.batchOps.batchMode) {
                    rowHTML += `<td><input type="checkbox" class="batch-checkbox" data-row-id="${escapeHtml(rec.row_id)}" ${isSelected ? 'checked' : ''} aria-label="Select row ${escapeHtml(rec.row_id)}"></td>`;
                }
                
                rowHTML += visibleColumns.map(h => {
                    let cellValue;
                    if (h === 'Annotation') {
                        cellValue = logEntry ? escapeHtml(logEntry.Annotation) : '<em>N/A</em>';
                    } else if (h === 'Comment') {
                        cellValue = logEntry ? escapeHtml(logEntry.Comment) : '<em>N/A</em>';
                    } else {
                        cellValue = rec[h] === null ? '<em>(Blank)</em>' : escapeHtml(String(rec[h]));
                    }
                    return `<td>${cellValue}</td>`;
                }).join('');
                
                rowHTML += '</tr>';
                return rowHTML;
            }).join('');
            
            // Select all page checkbox
            const selectAllPage = document.getElementById('select-all-page');
            if (selectAllPage) {
                selectAllPage.addEventListener('change', (e) => {
                    paginatedItems.forEach(rec => {
                        if (e.target.checked) {
                            this.batchOps.selectedRows.add(rec.row_id);
                        } else {
                            this.batchOps.selectedRows.delete(rec.row_id);
                        }
                    });
                    this.batchOps.updateCount();
                    this.updateGridView();
                });
            }
        }
        
        getCurrentPageRecords() {
            const processedData = this.sortData(this.filterData(this.currentDetailRecords));
            const start = (this.gridState.currentPage - 1) * CONFIG.ROWS_PER_PAGE;
            return processedData.slice(start, start + CONFIG.ROWS_PER_PAGE);
        }
        
        renderPaginationControls(totalRecords) {
            const container = document.getElementById('pagination-controls');
            if (!container) return;
            
            const totalPages = Math.ceil(totalRecords / CONFIG.ROWS_PER_PAGE);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<ul class="pagination pagination-sm" role="navigation" aria-label="Pagination">';
            
            html += `<li class="page-item ${this.gridState.currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" data-page="${this.gridState.currentPage - 1}" ${this.gridState.currentPage === 1 ? 'aria-disabled="true"' : ''}>Previous</a>
            </li>`;
            
            for (let i = 1; i <= totalPages; i++) {
                html += `<li class="page-item ${i === this.gridState.currentPage ? 'active' : ''}">
                    <a class="page-link" data-page="${i}" ${i === this.gridState.currentPage ? 'aria-current="page"' : ''}>${i}</a>
                </li>`;
            }
            
            html += `<li class="page-item ${this.gridState.currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" data-page="${this.gridState.currentPage + 1}" ${this.gridState.currentPage === totalPages ? 'aria-disabled="true"' : ''}>Next</a>
            </li>`;
            
            container.innerHTML = html + '</ul>';
        }
        
        handleFilterChange(checkbox) {
            const column = checkbox.dataset.column;
            const value = checkbox.value;
            
            if (!this.gridState.filters[column]) {
                this.gridState.filters[column] = new Set();
            }
            
            if (value === '__ALL__') {
                const allCheckboxes = document.querySelectorAll(`.multi-select-checkbox[data-column="${column}"]`);
                if (checkbox.checked) {
                    allCheckboxes.forEach(cb => {
                        cb.checked = true;
                        if (cb.value !== '__ALL__') {
                            this.gridState.filters[column].add(cb.value);
                        }
                    });
                } else {
                    allCheckboxes.forEach(cb => cb.checked = false);
                    this.gridState.filters[column].clear();
                }
            } else {
                if (checkbox.checked) {
                    this.gridState.filters[column].add(value);
                } else {
                    this.gridState.filters[column].delete(value);
                    const allCheckbox = document.querySelector(`.multi-select-checkbox[data-column="${column}"][value="__ALL__"]`);
                    if (allCheckbox) allCheckbox.checked = false;
                }
            }
            
            this.updateMultiSelectDisplay(column);
            this.gridState.currentPage = 1;
            
            debouncer.debounce('filter-change', () => {
                this.updateGridView();
            });
        }
        
        updateMultiSelectDisplay(column) {
            const button = document.querySelector(`.multi-select-button[data-column="${column}"]`);
            if (!button) return;
            
            const selectedCount = this.gridState.filters[column] ? this.gridState.filters[column].size : 0;
            const span = button.querySelector('span');
            
            if (selectedCount === 0) {
                span.textContent = 'All';
                span.className = '';
            } else {
                span.textContent = `${selectedCount} selected`;
                span.className = 'selected-count';
            }
        }
        
        handleSort(column) {
            if (this.gridState.sortColumn === column) {
                this.gridState.sortDirection = this.gridState.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.gridState.sortColumn = column;
                this.gridState.sortDirection = 'asc';
            }
            
            this.gridState.currentPage = 1;
            this.updateGridView();
        }
        
        handleRowClick(row) {
            if (!row) return;
            
            // Don't trigger if clicking on batch checkbox
            if (event.target.classList.contains('batch-checkbox')) return;
            
            // Reset annotation form
            document.getElementById('annotation-dropdown').value = "";
            document.getElementById('comment-input').value = "";
            document.getElementById('submit-annotation-btn').disabled = true;
            
            const alertSpot = document.getElementById('annotation-alert-spot');
            if (alertSpot) alertSpot.innerHTML = '';
            
            const rowId = row.dataset.rowId;
            this.selectedRowForAnnotation = this.currentDetailRecords.find(d => d.row_id === rowId);
            
            // Highlight selected row
            document.querySelectorAll('#details-table-body tr').forEach(r => r.classList.remove('table-primary'));
            row.classList.add('table-primary');
            
            // Check if already annotated
            const isAnnotated = this.annotationLog.some(log => log.row_id === rowId);
            document.getElementById('annotation-dropdown').disabled = isAnnotated;
            document.getElementById('comment-input').disabled = isAnnotated;
            
            if (isAnnotated) {
                const alertSpot = document.getElementById('annotation-alert-spot');
                if (alertSpot) {
                    alertSpot.innerHTML = `<div class="alert alert-info">This record has already been annotated.</div>`;
                }
            }
            
            // Load granular details
            this.loadGranularDetails(this.selectedRowForAnnotation);
        }
        
        // ==================== ANNOTATION ====================
        
        async handleAnnotation() {
            try {
                if (!this.selectedRowForAnnotation) {
                    throw new Error("Please select a row before submitting an annotation");
                }
                
                const annotation = document.getElementById('annotation-dropdown').value;
                const commentInput = document.getElementById('comment-input').value;
                const comment = sanitizeInput(commentInput);
                
                if (!annotation) {
                    throw new Error("Please select a classification");
                }
                
                // Check for duplicate
                if (this.annotationLog.some(log => log.row_id === this.selectedRowForAnnotation.row_id)) {
                    throw new Error("This row has already been annotated");
                }
                
                const logEntry = {
                    ...this.selectedRowForAnnotation,
                    Annotation: annotation,
                    Comment: comment,
                    Timestamp: new Date().toISOString()
                };
                
                // Validate
                const validation = validateAnnotation(logEntry);
                if (!validation.valid) {
                    throw new Error(validation.errors.join(', '));
                }
                
                // Save to history before making changes
                this.historyManager.push([...this.annotationLog]);
                
                // Add annotation
                this.annotationLog.push(logEntry);
                
                // Persist to storage
                this.saveAnnotations();
                
                // Update UI
                this.updateLogView();
                this.updateGridView();
                
                // Show success message
                const alertSpot = document.getElementById('annotation-alert-spot');
                if (alertSpot) {
                    alertSpot.innerHTML = `<div class="alert alert-success">Annotation for <strong>${escapeHtml(this.selectedRowForAnnotation.row_id)}</strong> saved successfully.</div>`;
                }
                
                // Disable form
                document.getElementById('annotation-dropdown').disabled = true;
                document.getElementById('comment-input').disabled = true;
                document.getElementById('submit-annotation-btn').disabled = true;
                
                UIHelpers.showToast('Annotation saved successfully', 'success');
                
                setTimeout(() => {
                    if (alertSpot) alertSpot.innerHTML = '';
                }, 4000);
                
            } catch (error) {
                console.error('Annotation failed:', error);
                UIHelpers.showToast(error.message, 'error');
                
                const alertSpot = document.getElementById('annotation-alert-spot');
                if (alertSpot) {
                    alertSpot.innerHTML = `<div class="alert alert-danger">${escapeHtml(error.message)}</div>`;
                }
            }
        }
        
        saveAnnotations() {
            const saved = StorageManager.save(CONFIG.ANNOTATION_STORAGE_KEY, this.annotationLog);
            if (!saved) {
                UIHelpers.showToast('Warning: Could not save to local storage', 'warning');
            }
        }
        
        clearAllAnnotations() {
            this.historyManager.push([...this.annotationLog]);
            this.annotationLog = [];
            this.saveAnnotations();
            this.updateLogView();
            this.updateGridView();
            UIHelpers.showToast('All annotations cleared', 'success');
        }
        
        // ==================== UNDO/REDO ====================
        
        undo() {
            const previousState = this.historyManager.undo();
            if (previousState) {
                this.annotationLog = previousState;
                this.saveAnnotations();
                this.updateLogView();
                this.updateGridView();
                UIHelpers.showToast('Undo successful', 'info');
            }
        }
        
        redo() {
            const nextState = this.historyManager.redo();
            if (nextState) {
                this.annotationLog = nextState;
                this.saveAnnotations();
                this.updateLogView();
                this.updateGridView();
                UIHelpers.showToast('Redo successful', 'info');
            }
        }
        
        // ==================== GRANULAR DETAILS ====================
        
        loadGranularDetails(rowData) {
            if (!rowData) return;
            
            const headers = ["row_id", "Week number", "path", "Journey type", "Team", "Business Unit", "Device", "Completed", "hard anomaly", "visitor_id", "visitor_no", "Page No", "mcvid", "agent_id", "correlation_id", "URL Referral", "ContentSquare URL Link"];
            
            let flatData = [];
            if (rowData.granular_details && rowData.granular_details.length > 0) {
                rowData.granular_details.forEach(detail => {
                    if (detail.visitor_pg_no && Array.isArray(detail.visitor_pg_no)) {
                        detail.visitor_pg_no.forEach(pgNo => {
                            const newRowData = { ...rowData };
                            delete newRowData.granular_details;
                            flatData.push({ ...newRowData, ...detail, "Page No": pgNo });
                        });
                    }
                });
            }
            
            let html = `
                <button class="btn btn-secondary btn-sm mb-3" onclick="app.goBackToExplorer()">
                    ← Back to Explorer
                </button>
                <h3 class="mb-3">Granular Details for Row ID: <span class="text-primary fw-bold">${escapeHtml(rowData.row_id)}</span></h3>
            `;
            
            if (flatData.length > 0) {
                html += `
                    <p class="text-muted">Displaying <strong>${flatData.length}</strong> total page views for this record.</p>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm table-hover table-striped">
                            <thead class="table-light">
                                <tr>${headers.map(h => `<th>${escapeHtml(h)}</th>`).join('')}</tr>
                            </thead>
                            <tbody>
                                ${flatData.map(row => `
                                    <tr>
                                        <td>${escapeHtml(row.row_id)}</td>
                                        <td>${escapeHtml(String(row["Week number"]))}</td>
                                        <td>${escapeHtml(row.path)}</td>
                                        <td>${row["Journey type"] ? escapeHtml(row["Journey type"]) : '<em>(Blank)</em>'}</td>
                                        <td>${escapeHtml(row.Team)}</td>
                                        <td>${escapeHtml(row["Business Unit"])}</td>
                                        <td>${row.Device ? escapeHtml(row.Device) : '<em>(Blank)</em>'}</td>
                                        <td>${escapeHtml(row.Completed)}</td>
                                        <td><span class="badge ${row['hard anomaly'] === 'true' ? 'bg-danger' : 'bg-success'}">${escapeHtml(row['hard anomaly'])}</span></td>
                                        <td><span class="badge bg-primary">${escapeHtml(row.visitor_id)}</span></td>
                                        <td><span class="badge bg-secondary">${escapeHtml(String(row.visitor_no))}</span></td>
                                        <td><span class="badge bg-info text-dark">${escapeHtml(String(row["Page No"]))}</span></td>
                                        <td>${escapeHtml(row.mcvid)}</td>
                                        <td>${escapeHtml(row.agent_id)}</td>
                                        <td>${escapeHtml(row.correlation_id)}</td>
                                        <td><a href="${escapeHtml(row['URL_Referral'])}" target="_blank" class="small">${escapeHtml((row['URL_Referral'] || '').substring(0, 35))}...</a></td>
                                        <td><a href="${escapeHtml(row['ContentSquare_URL_Link'])}" target="_blank">View Session</a></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html += '<div class="alert alert-warning mt-3">No granular visitor details available for this record.</div>';
            }
            
            document.getElementById('granular-details-content').innerHTML = html;
            
            // Switch to granular tab
            const tab = new bootstrap.Tab(document.getElementById('granular-tab'));
            tab.show();
        }
        
        goBackToExplorer() {
            document.getElementById('granular-details-content').innerHTML = `
                <div class="text-center p-5">
                    <p class="text-muted">Click on any row in the Annotation Explorer to view granular details.</p>
                </div>
            `;
            const tab = new bootstrap.Tab(document.getElementById('explorer-tab'));
            tab.show();
        }
        
        // ==================== LOG VIEW ====================
        
        updateLogView() {
            const tableHead = document.getElementById('log-table-head');
            const tableBody = document.getElementById('log-table-body');
            
            if (!tableHead || !tableBody) return;
            
            tableHead.innerHTML = `<tr>${CONFIG.LOG_DISPLAY_COLUMNS.map(h => `<th scope="col">${escapeHtml(h)}</th>`).join('')}</tr>`;
            
            const sortedLog = [...this.annotationLog].sort((a, b) => 
                new Date(b.Timestamp) - new Date(a.Timestamp)
            );
            
            tableBody.innerHTML = sortedLog.map(log => `
                <tr>
                    ${CONFIG.LOG_DISPLAY_COLUMNS.map(col => {
                        const value = log[col];
                        return `<td>${value === null || value === undefined ? '<em>(Blank)</em>' : escapeHtml(String(value))}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }
        
        // ==================== FILTER PRESETS ====================
        
        saveFilterPreset() {
            const name = prompt('Enter a name for this filter preset:');
            if (!name) return;
            
            this.filterPresets.save(name, this.gridState.filters);
            this.renderFilterPresets();
            UIHelpers.showToast('Filter preset saved', 'success');
        }
        
        renderFilterPresets() {
            const menu = document.getElementById('filter-presets-menu');
            const presets = this.filterPresets.getAll();
            
            let html = `
                <li><a class="dropdown-item" href="#" id="save-filter-preset">💾 Save Current Filters</a></li>
                <li><hr class="dropdown-divider"></li>
            `;
            
            if (presets.length === 0) {
                html += `<li><span class="dropdown-item text-muted">No saved filters</span></li>`;
            } else {
                presets.forEach(preset => {
                    html += `
                        <li class="d-flex justify-content-between align-items-center px-2">
                            <a class="dropdown-item flex-grow-1" href="#" onclick="app.applyFilterPreset(${preset.id}); return false;">
                                ${escapeHtml(preset.name)}
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="app.deleteFilterPreset(${preset.id}); event.stopPropagation(); return false;" aria-label="Delete preset ${escapeHtml(preset.name)}">
                                ×
                            </button>
                        </li>
                    `;
                });
            }
            
            menu.innerHTML = html;
        }
        
        applyFilterPreset(id) {
            const filters = this.filterPresets.apply(id);
            if (!filters) {
                UIHelpers.showToast('Preset not found', 'error');
                return;
            }
            
            this.gridState.filters = filters;
            this.gridState.currentPage = 1;
            
            // Update checkbox states
            this.updateFilterCheckboxStates();
            this.updateGridView();
            UIHelpers.showToast('Filter preset applied', 'success');
        }
        
        deleteFilterPreset(id) {
            if (confirm('Delete this filter preset?')) {
                this.filterPresets.delete(id);
                this.renderFilterPresets();
                UIHelpers.showToast('Preset deleted', 'success');
            }
        }
        
        updateFilterCheckboxStates() {
            Object.entries(this.gridState.filters).forEach(([column, values]) => {
                const checkboxes = document.querySelectorAll(`.multi-select-checkbox[data-column="${column}"]`);
                checkboxes.forEach(cb => {
                    if (cb.value === '__ALL__') {
                        cb.checked = false;
                    } else {
                        cb.checked = values.has(cb.value);
                    }
                });
                this.updateMultiSelectDisplay(column);
            });
        }
        
        // ==================== COLUMN TOGGLE ====================
        
        renderColumnToggle() {
            const menu = document.getElementById('column-toggle-menu');
            
            menu.innerHTML = CONFIG.DISPLAY_COLUMNS.map(col => `
                <li onclick="event.stopPropagation()">
                    <div class="form-check px-3 py-1">
                        <input class="form-check-input" type="checkbox" id="col-${col.replace(/\s+/g, '-')}" 
                               ${this.columnManager.isVisible(col) ? 'checked' : ''}
                               onchange="app.toggleColumn('${col}')">
                        <label class="form-check-label" for="col-${col.replace(/\s+/g, '-')}">
                            ${escapeHtml(col)}
                        </label>
                    </div>
                </li>
            `).join('');
        }
        
        toggleColumn(column) {
            this.columnManager.toggle(column);
            this.updateGridView();
        }
        
        // ==================== ANALYTICS ====================
        
        populateBatchAnnotationDropdown() {
            const select = document.getElementById('batch-annotation-select');
            select.innerHTML = '<option value="">Choose classification...</option>' +
                CONFIG.ANNOTATION_CATEGORIES.map(cat => `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`).join('');
        }
        
        renderAnalytics() {
            const container = document.getElementById('analytics-content');
            
            if (this.annotationLog.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5">
                        <p class="text-muted">No annotation data available. Please classify some records first.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Annotations by Classification</h5>
                                <canvas id="pie-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Annotations by Team</h5>
                                <canvas id="bar-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mt-4">
                    <div class="card-body">
                        <h5 class="card-title">Summary Statistics</h5>
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h3 class="text-primary">${this.annotationLog.length}</h3>
                                <p class="text-muted">Total Annotations</p>
                            </div>
                            <div class="col-md-3">
                                <h3 class="text-success">${new Set(this.annotationLog.map(l => l.row_id)).size}</h3>
                                <p class="text-muted">Unique Records</p>
                            </div>
                            <div class="col-md-3">
                                <h3 class="text-info">${new Set(this.annotationLog.map(l => l.Team)).size}</h3>
                                <p class="text-muted">Teams</p>
                            </div>
                            <div class="col-md-3">
                                <h3 class="text-warning">${new Set(this.annotationLog.map(l => l.Annotation)).size}</h3>
                                <p class="text-muted">Classifications Used</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            this.renderCharts();
        }
        
        renderCharts() {
            // Destroy existing charts
            if (this.chartInstances.pie) {
                this.chartInstances.pie.destroy();
                delete this.chartInstances.pie;
            }
            if (this.chartInstances.bar) {
                this.chartInstances.bar.destroy();
                delete this.chartInstances.bar;
            }
            
            // Pie chart
            const pieCtx = document.getElementById('pie-chart');
            if (pieCtx) {
                const annotationCounts = this.annotationLog.reduce((acc, log) => {
                    acc[log.Annotation] = (acc[log.Annotation] || 0) + 1;
                    return acc;
                }, {});
                
                this.chartInstances.pie = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(annotationCounts),
                        datasets: [{
                            data: Object.values(annotationCounts),
                            backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#6f42c1', '#fd7e14', '#20c997']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
            
            // Bar chart
            const barCtx = document.getElementById('bar-chart');
            if (barCtx) {
                const teamCounts = this.annotationLog.reduce((acc, log) => {
                    acc[log.Team] = (acc[log.Team] || 0) + 1;
                    return acc;
                }, {});
                
                this.chartInstances.bar = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(teamCounts),
                        datasets: [{
                            label: 'Annotations',
                            data: Object.values(teamCounts),
                            backgroundColor: '#0dcaf0'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }
        }
    }

    // ==================== INITIALIZATION ====================
    
    let app;
    
    document.addEventListener('DOMContentLoaded', function() {
        try {
            app = new AnomalyGridApp();
            window.app = app; // Make accessible globally for inline handlers
        } catch (error) {
            console.error('Failed to start application:', error);
            alert('Failed to start application. Please refresh the page.');
        }
    });
    </script>
</body>
</html>